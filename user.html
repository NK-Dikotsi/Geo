<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - GeoCarRental</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #2962FF;
            --primary-green: #00C853;
            --accent-yellow: #FFD600;
            --accent-orange: #FFAB40;
            --text-dark: #212121;
            --text-light: #757575;
            --bg-white: #FFFFFF;
            --bg-black: #121212;
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }
    
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            background-color: whitesmoke;
        }
    
        /* Navbar Styles - Updated to match index */
        .navbar {
            background-color: var(--bg-white);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            height: 80px;
        }
    
        .navbar-logo-container {
            height: 80px;
            display: flex;
            align-items: center;
            margin-right: auto;
        }
    
        .navbar-logo {
            height: 160px;
            width: auto;
            max-height: 100%;
            object-fit: contain;
        }
    
        .nav-links {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
    
        .auth-button {
            text-decoration: none;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.95rem;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            transition: var(--transition);
        }
    
        .auth-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    
        .host-button {
            text-decoration: none;
            color: white;
            background-color: #2962ff;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            border: 1px solid #2962ff;
            transition: var(--transition);
        }
    
        .host-button:hover {
            background-color: #1a4fd8;
            border-color: #1a4fd8;
        }
    
        /* Mobile Menu Toggle - Improved for better mobile experience */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-dark);
            z-index: 1001;
            padding: 0.5rem;
        }
    
        /* Account Container */
        .account-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 5%;
        }
        
        .account-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .account-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.5rem;
            overflow: hidden;
            position: relative;
        }
        
        .account-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary-blue);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .account-info {
            flex: 1;
            min-width: 250px;
        }
        
        .account-info h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .account-info p {
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        
        .profile-completion {
            width: 100%;
            margin-top: 1rem;
        }
        
        .completion-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        
        .completion-progress {
            height: 100%;
            background: var(--primary-blue);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .completion-text {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .completion-text strong {
            color: var(--primary-blue);
        }
        
        /* Account Sections */
        .account-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .account-section h2 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-edit {
            font-size: 0.9rem;
            color: var(--primary-blue);
            cursor: pointer;
            font-weight: 500;
        }
        
        .section-content {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .info-group {
            min-width: 200px;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 500;
        }
        
        .empty-value {
            color: var(--text-light);
            font-style: italic;
        }
        
        /* Edit Forms */
        .edit-form {
            display: none;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }
        
        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.2);
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .save-btn, .cancel-btn {
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .save-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
        }
        
        .save-btn:hover {
            background-color: #1a4fd8;
        }
        
        .cancel-btn {
            background: none;
            border: 1px solid #ddd;
        }
        
        .cancel-btn:hover {
            background: #f5f5f5;
        }
        
        /* Profile Photo Upload */
        #profilePhotoInput {
            display: none;
        }
        
        /* Cars Around You Section */
        .cars-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .car-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: var(--transition);
        }
        
        .car-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .car-image {
            height: 180px;
            width: 100%;
            object-fit: cover;
        }
        
        .car-details {
            padding: 1.2rem;
        }
        
        .car-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .car-price {
            color: var(--primary-blue);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .car-features {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .car-feature {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        .car-feature i {
            margin-right: 0.3rem;
            font-size: 0.9rem;
        }
        
        .car-location {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .car-location i {
            margin-right: 0.5rem;
            color: var(--primary-blue);
        }
        
        .no-cars {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        
        .no-cars-video {
            max-width: 400px;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
        }
        
        .no-cars p {
            color: var(--text-light);
            margin-bottom: 1rem;
        }
        
        .explore-btn {
            padding: 0.8rem 1.5rem;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .explore-btn:hover {
            background-color: #1a4fd8;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 350px;
            z-index: 9999;
            transform: translateX(0);
            transition: all 0.3s ease;
        }
        
        .notification.success {
            background-color: #4CAF50;
        }
        
        .notification.error {
            background-color: #F44336;
        }
        
        .notification.fade-out {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .close-notification {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 15px;
            padding: 0;
        }
        
        /* Responsive Styles - Improved mobile navigation */
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
    
            .nav-links {
                position: fixed;
                top: 0;
                left: -100%;
                width: 80%;
                height: 100vh;
                background-color: var(--bg-white);
                flex-direction: column;
                align-items: flex-start;
                padding: 6rem 2rem 2rem;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
                transition: var(--transition);
                z-index: 1000;
            }
    
            .nav-links.active {
                left: 0;
            }

            .auth-button, .host-button, .logout-btn {
                width: 100%;
                text-align: left;
                padding: 0.8rem 1rem;
                border-radius: 0;
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }

            .host-button {
                order: -1;
                margin-bottom: 1rem;
            }
            
            .account-avatar {
                width: 80px;
                height: 80px;
                margin-right: 1rem;
            }
            
            .account-info h1 {
                font-size: 1.5rem;
            }
            
            .account-section {
                padding: 1.5rem;
            }
            
            .section-content {
                gap: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .account-avatar {
                width: 70px;
                height: 70px;
            }
            
            .account-info h1 {
                font-size: 1.3rem;
            }
            
            .account-section h2 {
                font-size: 1.1rem;
            }
            
            .nav-links {
                width: 100%;
            }
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.95rem;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Overlay for mobile menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-logo-container">
            <a href="index.html">
                <img src="images/logoblack1.png" alt="GeoCarRental Logo" class="navbar-logo">
            </a>
        </div>
        
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="nav-links" id="navLinks">
            <a href="#" class="auth-button">Insurance</a>
            <a href="#" class="host-button">Become a Host</a>
            <button class="logout-btn" id="logoutBtn">Log Out</button>
        </div>
    </nav>

    <!-- Overlay for mobile menu -->
    <div class="overlay" id="overlay"></div>

    <!-- Account Content -->
    <main class="account-container">
        <div class="account-header">
            <div class="account-avatar">
                <img src="" alt="Profile" id="profileAvatar">
                <div class="avatar-edit" id="avatarEdit">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="profilePhotoInput" accept="image/*">
                </div>
            </div>
            <div class="account-info">
                <h1 id="userName">Loading...</h1>
                <p id="userEmail">Loading...</p>
                <p id="userPhone" class="empty-value">No phone number added</p>
                
                <div class="profile-completion">
                    <div class="completion-bar">
                        <div class="completion-progress" id="completionProgress"></div>
                    </div>
                    <p class="completion-text">Profile is <strong id="completionPercent">0%</strong> complete</p>
                </div>
            </div>
        </div>

         <!-- Cars Around You Section -->
         <div class="account-section">
            <h2>Cars Around You</h2>
            <div class="cars-container" id="carsContainer">
                <div class="no-cars">
                    <img src="videos/nocars.gif" alt="No cars available" class="no-cars-video">
                    <p>We're finding cars near you...</p>
                    <a href="#" class="explore-btn">Explore All Cars</a>
                </div>
            </div>
        </div>
        
        
        <!-- Personal Info Section -->
        <div class="account-section">
            <h2>
                Personal Information
                <span class="section-edit" id="editPersonalInfo">Edit</span>
            </h2>
            
            <div class="section-content">
                <div class="info-group">
                    <p class="info-label">Full Name</p>
                    <p class="info-value" id="displayName"></p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Email</p>
                    <p class="info-value" id="displayEmail"></p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Phone</p>
                    <p class="info-value" id="displayPhone"></p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Location</p>
                    <p class="info-value" id="displayLocation">Detecting your location...</p>
                </div>
            </div>
            
            <!-- Edit Personal Info Form -->
            <div class="edit-form" id="personalInfoForm">
                <div class="form-group">
                    <label for="editName">Full Name</label>
                    <input type="text" id="editName" required>
                </div>
                
                <div class="form-group">
                    <label for="editPhone">Phone Number</label>
                    <input type="tel" id="editPhone" placeholder="+1 (555) 123-4567">
                </div>
                
                <div class="form-group">
                    <label>Location</label>
                    <button type="button" class="save-btn" id="updateLocation" style="width: 100%;">
                        <span id="locationBtnText">Update My Location</span>
                    </button>
                    <p id="locationStatus" style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--text-light);"></p>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="save-btn" id="savePersonalInfo">Save Changes</button>
                    <button type="button" class="cancel-btn" id="cancelPersonalInfo">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Driver's License Section -->
        <div class="account-section">
            <h2>
                Driver's License
                <span class="section-edit" id="editLicense">Add License</span>
            </h2>
            
            <div class="section-content">
                <div class="info-group">
                    <p class="info-label">License Status</p>
                    <p class="info-value" id="licenseStatus">Not verified</p>
                </div>
            </div>
            
            <!-- Edit License Form -->
            <div class="edit-form" id="licenseForm">
                <div class="form-group">
                    <label for="licenseNumber">License Number</label>
                    <input type="text" id="licenseNumber" required>
                </div>
                
                <div class="form-group">
                    <label for="licenseState">State/Province</label>
                    <input type="text" id="licenseState" required>
                </div>
                
                <div class="form-group">
                    <label for="licenseExpiry">Expiration Date</label>
                    <input type="date" id="licenseExpiry" required>
                </div>
                
                <div class="form-group">
                    <label>Upload Photos</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <div style="flex: 1;">
                            <label for="licenseFront" style="display: block; margin-bottom: 0.5rem;">Front</label>
                            <input type="file" id="licenseFront" accept="image/*">
                        </div>
                        <div style="flex: 1;">
                            <label for="licenseBack" style="display: block; margin-bottom: 0.5rem;">Back</label>
                            <input type="file" id="licenseBack" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="save-btn" id="saveLicense">Submit for Verification</button>
                    <button type="button" class="cancel-btn" id="cancelLicense">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Payment Methods Section -->
        <div class="account-section">
            <h2>
                Payment Methods
                <span class="section-edit" id="editPayment">Add Payment</span>
            </h2>
            
            <div class="section-content">
                <div class="info-group">
                    <p class="info-label">Primary Payment</p>
                    <p class="info-value empty-value">No payment method added</p>
                </div>
            </div>
            
            <!-- Edit Payment Form -->
            <div class="edit-form" id="paymentForm">
                <div class="form-group">
                    <label for="cardNumber">Card Number</label>
                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                </div>
                
                <div class="form-group">
                    <label for="cardName">Name on Card</label>
                    <input type="text" id="cardName" required>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label for="cardExpiry">Expiry Date</label>
                        <input type="text" id="cardExpiry" placeholder="MM/YY" required>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label for="cardCvv">CVV</label>
                        <input type="text" id="cardCvv" placeholder="123" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="save-btn" id="savePayment">Save Payment Method</button>
                    <button type="button" class="cancel-btn" id="cancelPayment">Cancel</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Enhanced Mobile Menu Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menuToggle');
            const navLinks = document.getElementById('navLinks');
            const overlay = document.getElementById('overlay');

            function toggleMenu() {
                navLinks.classList.toggle('active');
                overlay.classList.toggle('active');
                
                // Change icon based on menu state
                if (navLinks.classList.contains('active')) {
                    menuToggle.innerHTML = '<i class="fas fa-times"></i>';
                    document.body.style.overflow = 'hidden'; // Prevent scrolling when menu is open
                } else {
                    menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
                    document.body.style.overflow = ''; // Re-enable scrolling
                }
            }

            if (menuToggle && navLinks) {
                menuToggle.addEventListener('click', toggleMenu);
                
                // Close menu when clicking on overlay
                overlay.addEventListener('click', toggleMenu);
                
                // Close menu when clicking on any nav link (for mobile)
                navLinks.querySelectorAll('a, button').forEach(item => {
                    item.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            toggleMenu();
                        }
                    });
                });
            }
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { 
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAMU2y175sXjHkxAv6SF88-E9FCjaR2kJc",
            authDomain: "geocarrental-9a4de.firebaseapp.com",
            projectId: "geocarrental-9a4de",
            storageBucket: "geocarrental-9a4de.appspot.com",
            messagingSenderId: "951760186950",
            appId: "1:951760186950:web:7e8cc25aacdd251f152447",
            measurementId: "G-LJEF344295"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
    
        // Geoapify API Key
        const GEOAPIFY_API_KEY = "2ca9e48dc90443978775d9ef8792b96e";
    
        // DOM elements
        const logoutBtn = document.getElementById('logoutBtn');
        const profileAvatar = document.getElementById('profileAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhone = document.getElementById('userPhone');
        const accountLink = document.getElementById('accountLink');
        const completionProgress = document.getElementById('completionProgress');
        const completionPercent = document.getElementById('completionPercent');
        const displayLocation = document.getElementById('displayLocation');
        const updateLocation = document.getElementById('updateLocation');
        const locationStatus = document.getElementById('locationStatus');
        const carsContainer = document.getElementById('carsContainer');
        
        // Profile edit elements
        const avatarEdit = document.getElementById('avatarEdit');
        const profilePhotoInput = document.getElementById('profilePhotoInput');
        
        // Personal info elements
        const editPersonalInfo = document.getElementById('editPersonalInfo');
        const personalInfoForm = document.getElementById('personalInfoForm');
        const savePersonalInfo = document.getElementById('savePersonalInfo');
        const cancelPersonalInfo = document.getElementById('cancelPersonalInfo');
        const displayName = document.getElementById('displayName');
        const displayEmail = document.getElementById('displayEmail');
        const displayPhone = document.getElementById('displayPhone');
        const editName = document.getElementById('editName');
        const editPhone = document.getElementById('editPhone');
        
        // License elements
        const editLicense = document.getElementById('editLicense');
        const licenseForm = document.getElementById('licenseForm');
        const saveLicense = document.getElementById('saveLicense');
        const cancelLicense = document.getElementById('cancelLicense');
        const licenseStatus = document.getElementById('licenseStatus');
        
        // Payment elements
        const editPayment = document.getElementById('editPayment');
        const paymentForm = document.getElementById('paymentForm');
        const savePayment = document.getElementById('savePayment');
        const cancelPayment = document.getElementById('cancelPayment');
    
        // Notification system
        function showNotification(message, isSuccess = true) {
            const notification = document.createElement('div');
            notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="close-notification">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            const timer = setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 2000);
            
            notification.querySelector('.close-notification').addEventListener('click', () => {
                clearTimeout(timer);
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            });
        }
    
        // Calculate profile completion percentage
        function calculateProfileCompletion(userData) {
            let completedFields = 0;
            const totalFields = 4; // name, email, phone, license
            
            if (userData.name) completedFields++;
            if (userData.email) completedFields++;
            if (userData.phone) completedFields++;
            if (userData.licenseVerified) completedFields++;
            
            const percentage = Math.round((completedFields / totalFields) * 100);
            return percentage;
        }
    
        // Update profile completion UI
        function updateProfileCompletion(percentage) {
            completionProgress.style.width = `${percentage}%`;
            completionPercent.textContent = `${percentage}%`;
        }
    
        // Validate phone number
        function validatePhoneNumber(phone) {
            const regex = /^\+?[\d\s\-\(\)]{8,}$/;
            return regex.test(phone);
        }
    
        // Validate name
        function validateName(name) {
            return name.length >= 2;
        }
    
        // Get device location using browser's Geolocation API and Geoapify for reverse geocoding
        async function getDeviceLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by your browser'));
                    return;
                }
    
                locationStatus.textContent = "Detecting your location...";
                updateLocation.disabled = true;
                updateLocation.querySelector('#locationBtnText').textContent = "Detecting...";
    
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const { latitude, longitude } = position.coords;
                            
                            // Use Geoapify Reverse Geocoding API
                            const response = await fetch(
                                `https://api.geoapify.com/v1/geocode/reverse?lat=${latitude}&lon=${longitude}&apiKey=${GEOAPIFY_API_KEY}`,
                                { method: 'GET' }
                            );
                            
                            if (!response.ok) {
                                throw new Error('Failed to fetch location data');
                            }
                            
                            const data = await response.json();
                            
                            // Extract the most relevant address information
                            let locationName = "Unknown location";
                            if (data.features && data.features.length > 0) {
                                const properties = data.features[0].properties;
                                locationName = [
                                    properties.address_line1,
                                    properties.address_line2,
                                    properties.city,
                                    properties.country
                                ].filter(Boolean).join(', ');
                            }
                            
                            resolve({
                                coordinates: { latitude, longitude },
                                address: locationName
                            });
                        } catch (error) {
                            console.error("Error getting location:", error);
                            // Fallback to just coordinates if API fails
                            resolve({
                                coordinates: { latitude, longitude },
                                address: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`
                            });
                        } finally {
                            updateLocation.disabled = false;
                            updateLocation.querySelector('#locationBtnText').textContent = "Update My Location";
                        }
                    },
                    (error) => {
                        console.error("Error getting position:", error);
                        locationStatus.textContent = "Location access denied. Please enable location services.";
                        updateLocation.disabled = false;
                        updateLocation.querySelector('#locationBtnText').textContent = "Update My Location";
                        reject(error);
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 20000,
                        maximumAge: 0
                    }
                );
            });
        }
    
        // Show cars around user's location
        async function showCarsNearYou(location) {
            try {
                carsContainer.innerHTML = '';
                const noCarsDiv = document.createElement('div');
                noCarsDiv.className = 'no-cars';
                
                const image = document.createElement('img');
                image.src = 'videos/nocars.gif';
                image.alt = 'No cars available';
                image.className = 'no-cars-video';
                
                const message = document.createElement('p');
                message.textContent = location 
                    ? `Finding cars near ${location}...`
                    : 'We cannot determine your current location';
                
                const exploreBtn = document.createElement('a');
                exploreBtn.href = '#';
                exploreBtn.className = 'explore-btn';
                exploreBtn.textContent = 'Explore All Cars';
                
                if (location) {
                    const locationDisplay = document.createElement('p');
                    locationDisplay.className = 'location-display';
                    locationDisplay.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${location}`;
                    noCarsDiv.appendChild(locationDisplay);
                }
                
                noCarsDiv.appendChild(image);
                noCarsDiv.appendChild(message);
                noCarsDiv.appendChild(exploreBtn);
                carsContainer.appendChild(noCarsDiv);
                
                // Simulate loading cars (in a real app, you would fetch actual data)
                setTimeout(() => {
                    message.textContent = location 
                        ? `No cars available near ${location}`
                        : 'No cars available - location unknown';
                }, 2000);
                
            } catch (error) {
                console.error("Error loading cars:", error);
                carsContainer.innerHTML = `
                    <div class="no-cars">
                        <img src="videos/nocars.gif" alt="No cars available" class="no-cars-video">
                        <p>Error loading cars. Please try again later.</p>
                        <a href="#" class="explore-btn">Explore All Cars</a>
                    </div>
                `;
            }
        }
    
        const uploadFile = async (file, pathPrefix) => {
    try {
        const user = auth.currentUser;
        if (!user) {
            showNotification('Please sign in to upload files', false);
            throw new Error('User not authenticated');
        }

        // Create unique filename with user ID
        const timestamp = Date.now();
        const fileExtension = file.name.split('.').pop();
        const fileName = `${pathPrefix}_${user.uid}_${timestamp}.${fileExtension}`;
        
        // Create storage reference
        const storageRef = ref(storage, `${pathPrefix}/${fileName}`);
        
        // Show upload progress
        avatarEdit.innerHTML = '<div class="loading"></div>';
        
        // Create file metadata
        const metadata = {
            contentType: file.type,
            customMetadata: {
                uploadedBy: user.uid,
                originalName: file.name
            }
        };

        // Upload file
        const snapshot = await uploadBytesResumable(storageRef, file, metadata);
        const downloadURL = await getDownloadURL(snapshot.ref);
        
        // Update UI
        avatarEdit.innerHTML = '<i class="fas fa-camera"></i>';
        return downloadURL;
        
    } catch (error) {
        console.error('Upload failed:', error);
        avatarEdit.innerHTML = '<i class="fas fa-camera"></i>';
        showNotification('Upload failed. Please try again.', false);
        throw error;
    }
};
        // Check auth state and load user data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Get user data from Firestore
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    let userData;
                    
                    if (userDoc.exists()) {
                        userData = userDoc.data();
                    } else {
                        // Create user document if it doesn't exist
                        userData = {
                            userId: user.uid,
                            email: user.email,
                            name: user.displayName || '',
                            phone: '',
                            profilePic: user.photoURL || '',
                            location: '',
                            coordinates: null,
                            licenseVerified: false,
                            licenseSubmitted: false,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };
                        await setDoc(userDocRef, userData);
                        showNotification('Profile created successfully!');
                    }
                    
                    // Display user info
                    userName.textContent = userData.name || user.email;
                    userEmail.textContent = user.email;
                    displayName.textContent = userData.name || 'Not provided';
                    displayEmail.textContent = user.email;
                    
                    if (userData.phone) {
                        userPhone.textContent = userData.phone;
                        displayPhone.textContent = userData.phone;
                        userPhone.classList.remove('empty-value');
                    } else {
                        userPhone.textContent = 'No phone number added';
                        displayPhone.textContent = 'Not provided';
                        userPhone.classList.add('empty-value');
                    }
                    
                    if (userData.location) {
                        displayLocation.textContent = userData.location;
                        displayLocation.classList.remove('empty-value');
                        // Show cars near this location
                        await showCarsNearYou(userData.location);
                    } else {
                        displayLocation.textContent = 'Location not set';
                        displayLocation.classList.add('empty-value');
                        // Try to fetch location automatically on first load if not set
                        try {
                            const locationData = await getDeviceLocation();
                            await updateDoc(userDocRef, {
                                location: locationData.address,
                                coordinates: locationData.coordinates,
                                updatedAt: serverTimestamp()
                            });
                            displayLocation.textContent = locationData.address;
                            displayLocation.classList.remove('empty-value');
                            await showCarsNearYou(locationData.address);
                        } catch (error) {
                            console.error('Error fetching initial location:', error);
                            await showCarsNearYou();
                        }
                    }
                    
                    // Update profile picture - prioritize auth photoURL over Firestore
                    if (user.photoURL) {
                        profileAvatar.src = `${user.photoURL}?t=${Date.now()}`;
                    } else if (userData.profilePic) {
                        profileAvatar.src = `${userData.profilePic}?t=${Date.now()}`;
                    } else {
                        // Default avatar if no profile picture
                        profileAvatar.src = "images/default-avatar.png";
                    }
                    
                    // Update license status
                    if (userData.licenseVerified) {
                        licenseStatus.textContent = 'Verified';
                        licenseStatus.style.color = 'var(--primary-green)';
                        editLicense.textContent = 'View License';
                    } else if (userData.licenseSubmitted) {
                        licenseStatus.textContent = 'Under Review';
                        licenseStatus.style.color = 'var(--accent-yellow)';
                        editLicense.textContent = 'View Details';
                    } else {
                        licenseStatus.textContent = 'Not verified';
                        licenseStatus.style.color = 'var(--text-light)';
                        editLicense.textContent = 'Add License';
                    }
                    
                    // Calculate and update profile completion
                    const completionPercentage = calculateProfileCompletion(userData);
                    updateProfileCompletion(completionPercentage);
                    
                    // Pre-fill edit forms with actual user data
                    editName.value = userData.name || '';
                    editPhone.value = userData.phone || '';
                    
                } catch (error) {
                    console.error("Error getting user data:", error);
                    showNotification('Error loading profile data. Please try again.', false);
                    await showCarsNearYou();
                }
            } else {
                // No user is signed in, redirect to index.html
                window.location.href = "index.html";
            }
        });
    
        // Logout button
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
                showNotification('Error signing out. Please try again.', false);
            }
        });
    
        // Profile photo upload
        avatarEdit.addEventListener('click', () => {
            profilePhotoInput.click();
        });
    
        profilePhotoInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                // Show loading state immediately
                avatarEdit.innerHTML = '<div class="loading"></div>';
                
                // Create a preview URL for instant feedback
                const previewUrl = URL.createObjectURL(file);
                profileAvatar.src = previewUrl;
                
                // Upload the file using our improved function
                const downloadURL = await uploadFile(file, 'profile_pictures');
                
                // Update profile picture in Firebase Auth
                await updateProfile(user, {
                    photoURL: downloadURL
                });
                
                // Update profile picture in Firestore
                const userDocRef = doc(db, "users", user.uid);
                await updateDoc(userDocRef, {
                    profilePic: downloadURL,
                    updatedAt: serverTimestamp()
                });
                
                // Update UI with final image (add timestamp to prevent caching)
                profileAvatar.src = `${downloadURL}?t=${Date.now()}`;
                avatarEdit.innerHTML = '<i class="fas fa-camera"></i>';
                
                showNotification('Profile picture updated successfully!');
                
                // Recalculate profile completion
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const completionPercentage = calculateProfileCompletion(userDoc.data());
                    updateProfileCompletion(completionPercentage);
                }
                
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                avatarEdit.innerHTML = '<i class="fas fa-camera"></i>';
                showNotification('Failed to update profile picture. Please try again.', false);
                
                // Reset to previous image if available
                const user = auth.currentUser;
                if (user && user.photoURL) {
                    profileAvatar.src = `${user.photoURL}?t=${Date.now()}`;
                } else {
                    profileAvatar.src = "images/default-avatar.png";
                }
            }
        });
    
        // Personal Info Edit
        editPersonalInfo.addEventListener('click', () => {
            personalInfoForm.style.display = 'block';
        });
    
        cancelPersonalInfo.addEventListener('click', () => {
            personalInfoForm.style.display = 'none';
        });
    
        // Update location button
        updateLocation.addEventListener('click', async () => {
            try {
                const locationData = await getDeviceLocation();
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                const userDocRef = doc(db, "users", user.uid);
                await updateDoc(userDocRef, {
                    location: locationData.address,
                    coordinates: locationData.coordinates,
                    updatedAt: serverTimestamp()
                });
                
                // Update UI
                displayLocation.textContent = locationData.address;
                displayLocation.classList.remove('empty-value');
                locationStatus.textContent = "Location updated successfully!";
                
                // Show cars near the new location
                await showCarsNearYou(locationData.address);
                
                // Recalculate profile completion
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const completionPercentage = calculateProfileCompletion(userDoc.data());
                    updateProfileCompletion(completionPercentage);
                }
                
                showNotification('Location updated successfully!');
                
            } catch (error) {
                console.error('Error updating location:', error);
                locationStatus.textContent = "Failed to update location. Please try again.";
            }
        });
    
        savePersonalInfo.addEventListener('click', async () => {
            const name = editName.value.trim();
            const phone = editPhone.value.trim();
            
            // Validate inputs
            if (!validateName(name)) {
                showNotification('Please enter a valid name (at least 2 characters)', false);
                return;
            }
            
            if (phone && !validatePhoneNumber(phone)) {
                showNotification('Please enter a valid phone number', false);
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                const userDocRef = doc(db, "users", user.uid);
                
                // Show loading state
                savePersonalInfo.disabled = true;
                savePersonalInfo.innerHTML = '<div class="loading"></div> Saving...';
                
                // Update user data in Firestore
                await updateDoc(userDocRef, {
                    name: name,
                    phone: phone || null,
                    updatedAt: serverTimestamp()
                });
                
                // Update UI
                displayName.textContent = name;
                userName.textContent = name || user.email;
                
                if (phone) {
                    displayPhone.textContent = phone;
                    userPhone.textContent = phone;
                    userPhone.classList.remove('empty-value');
                } else {
                    displayPhone.textContent = 'Not provided';
                    userPhone.textContent = 'No phone number added';
                    userPhone.classList.add('empty-value');
                }
                
                // Hide form
                personalInfoForm.style.display = 'none';
                
                // Update profile completion
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const completionPercentage = calculateProfileCompletion(userDoc.data());
                    updateProfileCompletion(completionPercentage);
                }
                
                showNotification('Profile updated successfully!');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Failed to update profile. Please try again.', false);
            } finally {
                savePersonalInfo.disabled = false;
                savePersonalInfo.textContent = 'Save Changes';
            }
        });
    
        // License Edit
        editLicense.addEventListener('click', () => {
            licenseForm.style.display = 'block';
        });
    
        cancelLicense.addEventListener('click', () => {
            licenseForm.style.display = 'none';
        });
    
        saveLicense.addEventListener('click', async () => {
            const licenseNumber = document.getElementById('licenseNumber').value.trim();
            const licenseState = document.getElementById('licenseState').value.trim();
            const licenseExpiry = document.getElementById('licenseExpiry').value;
            const licenseFront = document.getElementById('licenseFront').files[0];
            const licenseBack = document.getElementById('licenseBack').files[0];
            
            // Validate inputs
            if (!licenseNumber || !licenseState || !licenseExpiry) {
                showNotification('Please fill all required fields', false);
                return;
            }
            
            if (!licenseFront || !licenseBack) {
                showNotification('Please upload both front and back of your license', false);
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                const userDocRef = doc(db, "users", user.uid);
                
                // Show loading state
                saveLicense.disabled = true;
                saveLicense.innerHTML = '<div class="loading"></div> Submitting...';
                
                // Upload license images using our improved function
                const [frontURL, backURL] = await Promise.all([
                    uploadFile(licenseFront, 'licenses'),
                    uploadFile(licenseBack, 'licenses')
                ]);
                
                // Update user data in Firestore
                await updateDoc(userDocRef, {
                    licenseNumber: licenseNumber,
                    licenseState: licenseState,
                    licenseExpiry: licenseExpiry,
                    licenseFront: frontURL,
                    licenseBack: backURL,
                    licenseSubmitted: true,
                    licenseVerified: false,
                    updatedAt: serverTimestamp()
                });
                
                // Update UI
                licenseStatus.textContent = 'Under Review';
                licenseStatus.style.color = 'var(--accent-yellow)';
                editLicense.textContent = 'View Details';
                licenseForm.style.display = 'none';
                saveLicense.disabled = false;
                saveLicense.textContent = 'Submit for Verification';
                
                // Update profile completion
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const completionPercentage = calculateProfileCompletion(userDoc.data());
                    updateProfileCompletion(completionPercentage);
                }
                
                showNotification('License submitted for verification!');
                
            } catch (error) {
                console.error('Error submitting license:', error);
                saveLicense.disabled = false;
                saveLicense.textContent = 'Submit for Verification';
                showNotification('Failed to submit license. Please try again.', false);
            }
        });
    
        // Payment Edit
        editPayment.addEventListener('click', () => {
            paymentForm.style.display = 'block';
        });
    
        cancelPayment.addEventListener('click', () => {
            paymentForm.style.display = 'none';
        });
    
        savePayment.addEventListener('click', async () => {
            const cardNumber = document.getElementById('cardNumber').value.trim();
            const cardName = document.getElementById('cardName').value.trim();
            const cardExpiry = document.getElementById('cardExpiry').value.trim();
            const cardCvv = document.getElementById('cardCvv').value.trim();
            
            // Validate inputs (basic validation)
            if (!cardNumber || !cardName || !cardExpiry || !cardCvv) {
                showNotification('Please fill all required fields', false);
                return;
            }
            
            if (cardNumber.length < 16) {
                showNotification('Please enter a valid card number', false);
                return;
            }
            
            if (cardCvv.length < 3) {
                showNotification('Please enter a valid CVV', false);
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                const userDocRef = doc(db, "users", user.uid);
                
                // Show loading state
                savePayment.disabled = true;
                savePayment.innerHTML = '<div class="loading"></div> Processing...';
                
                // In a real app, you would use a payment processor API here
                // For demo purposes, we'll just store the last 4 digits
                const last4 = cardNumber.slice(-4);
                
                await updateDoc(userDocRef, {
                    paymentMethod: {
                        type: 'card',
                        last4: last4,
                        name: cardName,
                        expiry: cardExpiry
                    },
                    updatedAt: serverTimestamp()
                });
                
                // Update UI
                paymentForm.style.display = 'none';
                savePayment.disabled = false;
                savePayment.textContent = 'Save Payment Method';
                showNotification('Payment method added successfully!');
                
            } catch (error) {
                console.error('Error adding payment method:', error);
                savePayment.disabled = false;
                savePayment.textContent = 'Save Payment Method';
                showNotification('Failed to add payment method. Please try again.', false);
            }
        });
        
    </script>
</body>
</html>