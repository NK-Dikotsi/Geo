<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - GeoCarRental</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #2962FF;
            --primary-green: #00C853;
            --accent-yellow: #FFD600;
            --accent-orange: #FFAB40;
            --text-dark: #212121;
            --text-light: #757575;
            --bg-white: #FFFFFF;
            --bg-black: #121212;
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }
    
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            background-color: #fffbed;
        }
    
        /* Navbar Styles */
        .navbar {
            background-color: var(--bg-white);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            height: 80px;
        }
    
        .navbar-logo-container {
            height: 80px;
            display: flex;
            align-items: center;
            margin-right: auto;
        }
    
        .navbar-logo {
            height: 160px;
            width: auto;
            max-height: 100%;
            object-fit: contain;
        }
    
        .nav-links {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
    
        .auth-button {
            text-decoration: none;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.95rem;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            transition: var(--transition);
        }
    
        .auth-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    
        .host-button {
            text-decoration: none;
            color: white;
            background-color: #2962ff;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            border: 1px solid #2962ff;
            transition: var(--transition);
        }
    
        .host-button:hover {
            background-color: #1a4fd8;
            border-color: #1a4fd8;
        }
    
        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-dark);
        }
    
        /* Account Container */
        .account-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 5%;
        }
        
        .account-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .account-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.5rem;
            overflow: hidden;
            position: relative;
        }
        
        .account-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary-blue);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .account-info {
            flex: 1;
            min-width: 250px;
        }
        
        .account-info h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .account-info p {
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        
        .profile-completion {
            width: 100%;
            margin-top: 1rem;
        }
        
        .completion-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        
        .completion-progress {
            height: 100%;
            background: var(--primary-blue);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .completion-text {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .completion-text strong {
            color: var(--primary-blue);
        }
        
        /* Account Sections */
        .account-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .account-section h2 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-edit {
            font-size: 0.9rem;
            color: var(--primary-blue);
            cursor: pointer;
            font-weight: 500;
        }
        
        .section-content {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .info-group {
            min-width: 200px;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 500;
        }
        
        .empty-value {
            color: var(--text-light);
            font-style: italic;
        }
        
        /* Edit Forms */
        .edit-form {
            display: none;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }
        
        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.2);
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .save-btn, .cancel-btn {
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .save-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
        }
        
        .save-btn:hover {
            background-color: #1a4fd8;
        }
        
        .cancel-btn {
            background: none;
            border: 1px solid #ddd;
        }
        
        .cancel-btn:hover {
            background: #f5f5f5;
        }
        
        /* Profile Photo Upload */
        #profilePhotoInput {
            display: none;
        }
        
        /* Trips Section */
        .trips-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .no-trips {
            color: var(--text-light);
            font-style: italic;
            padding: 2rem 0;
            text-align: center;
        }
        
        /* Logout Button */
        .logout-btn {
            display: inline-block;
            background-color: #ff5252;
            color: white;
            padding: 0.8rem 1.8rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
        }
        
        .logout-btn:hover {
            background-color: #ff3232;
            transform: translateY(-2px);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 350px;
            z-index: 9999;
            transform: translateX(0);
            transition: all 0.3s ease;
        }
        
        .notification.success {
            background-color: #4CAF50;
        }
        
        .notification.error {
            background-color: #F44336;
        }
        
        .notification.fade-out {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .close-notification {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 15px;
            padding: 0;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
    
            .nav-links {
                position: fixed;
                top: 80px;
                left: 0;
                width: 100%;
                background-color: var(--bg-white);
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem 5%;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                gap: 1rem;
                transform: translateY(-150%);
                transition: var(--transition);
                z-index: 999;
            }
    
            .nav-links.active {
                transform: translateY(0);
            }
            
            .account-avatar {
                width: 80px;
                height: 80px;
                margin-right: 1rem;
            }
            
            .account-info h1 {
                font-size: 1.5rem;
            }
            
            .account-section {
                padding: 1.5rem;
            }
            
            .section-content {
                gap: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .account-avatar {
                width: 70px;
                height: 70px;
            }
            
            .account-info h1 {
                font-size: 1.3rem;
            }
            
            .account-section h2 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-logo-container">
            <a href="index.html">
                <img src="images/logoblack1.png" alt="GeoCarRental Logo" class="navbar-logo">
            </a>
        </div>
        
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="nav-links" id="navLinks">
            <a href="#" class="auth-button" id="accountLink">My Account</a>
            <a href="#" class="auth-button">Insurance</a>
            <a href="#" class="host-button">Become a Host</a>
            <button class="logout-btn" id="logoutBtn">Log Out</button>
        </div>
    </nav>

    <!-- Account Content -->
    <main class="account-container">
        <div class="account-header">
            <div class="account-avatar">
                <img src="" alt="Profile" id="profileAvatar">
                <div class="avatar-edit" id="avatarEdit">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="profilePhotoInput" accept="image/*">
                </div>
            </div>
            <div class="account-info">
                <h1 id="userName">Loading...</h1>
                <p id="userEmail">Loading...</p>
                <p id="userPhone" class="empty-value">No phone number added</p>
                
                <div class="profile-completion">
                    <div class="completion-bar">
                        <div class="completion-progress" id="completionProgress"></div>
                    </div>
                    <p class="completion-text">Profile is <strong id="completionPercent">0%</strong> complete</p>
                </div>
            </div>
        </div>
        
        <!-- Personal Info Section -->
        <div class="account-section">
            <h2>
                Personal Information
                <span class="section-edit" id="editPersonalInfo">Edit</span>
            </h2>
            
            <div class="section-content">
                <div class="info-group">
                    <p class="info-label">Full Name</p>
                    <p class="info-value" id="displayName">John Doe</p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Email</p>
                    <p class="info-value" id="displayEmail">john@example.com</p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Phone</p>
                    <p class="info-value" id="displayPhone">+1 (555) 123-4567</p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Address</p>
                    <p class="info-value" id="displayAddress">123 Main St, Anytown, USA</p>
                </div>
            </div>
            
            <!-- Edit Personal Info Form -->
            <div class="edit-form" id="personalInfoForm">
                <div class="form-group">
                    <label for="editName">Full Name</label>
                    <input type="text" id="editName" required>
                </div>
                
                <div class="form-group">
                    <label for="editPhone">Phone Number</label>
                    <input type="tel" id="editPhone" placeholder="+1 (555) 123-4567">
                </div>
                
                <div class="form-group">
                    <label for="editAddress">Address</label>
                    <textarea id="editAddress" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="save-btn" id="savePersonalInfo">Save Changes</button>
                    <button type="button" class="cancel-btn" id="cancelPersonalInfo">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Driver's License Section -->
        <div class="account-section">
            <h2>
                Driver's License
                <span class="section-edit" id="editLicense">Add License</span>
            </h2>
            
            <div class="section-content">
                <div class="info-group">
                    <p class="info-label">License Status</p>
                    <p class="info-value" id="licenseStatus">Not verified</p>
                </div>
            </div>
            
            <!-- Edit License Form -->
            <div class="edit-form" id="licenseForm">
                <div class="form-group">
                    <label for="licenseNumber">License Number</label>
                    <input type="text" id="licenseNumber" required>
                </div>
                
                <div class="form-group">
                    <label for="licenseState">State/Province</label>
                    <input type="text" id="licenseState" required>
                </div>
                
                <div class="form-group">
                    <label for="licenseExpiry">Expiration Date</label>
                    <input type="date" id="licenseExpiry" required>
                </div>
                
                <div class="form-group">
                    <label>Upload Photos</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <div style="flex: 1;">
                            <label for="licenseFront" style="display: block; margin-bottom: 0.5rem;">Front</label>
                            <input type="file" id="licenseFront" accept="image/*">
                        </div>
                        <div style="flex: 1;">
                            <label for="licenseBack" style="display: block; margin-bottom: 0.5rem;">Back</label>
                            <input type="file" id="licenseBack" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="save-btn" id="saveLicense">Submit for Verification</button>
                    <button type="button" class="cancel-btn" id="cancelLicense">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Payment Methods Section -->
        <div class="account-section">
            <h2>
                Payment Methods
                <span class="section-edit" id="editPayment">Add Payment</span>
            </h2>
            
            <div class="section-content">
                <div class="info-group">
                    <p class="info-label">Primary Payment</p>
                    <p class="info-value empty-value">No payment method added</p>
                </div>
            </div>
            
            <!-- Edit Payment Form -->
            <div class="edit-form" id="paymentForm">
                <div class="form-group">
                    <label for="cardNumber">Card Number</label>
                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                </div>
                
                <div class="form-group">
                    <label for="cardName">Name on Card</label>
                    <input type="text" id="cardName" required>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label for="cardExpiry">Expiry Date</label>
                        <input type="text" id="cardExpiry" placeholder="MM/YY" required>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label for="cardCvv">CVV</label>
                        <input type="text" id="cardCvv" placeholder="123" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="save-btn" id="savePayment">Save Payment Method</button>
                    <button type="button" class="cancel-btn" id="cancelPayment">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Your Trips Section -->
        <div class="account-section">
            <h2>Your Trips</h2>
            <div class="trips-container" id="tripsContainer">
                <p class="no-trips">You don't have any upcoming trips.</p>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { 
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAMU2y175sXjHkxAv6SF88-E9FCjaR2kJc",
            authDomain: "geocarrental-9a4de.firebaseapp.com",
            projectId: "geocarrental-9a4de",
            storageBucket: "geocarrental-9a4de.firebasestorage.app",
            messagingSenderId: "951760186950",
            appId: "1:951760186950:web:7e8cc25aacdd251f152447",
            measurementId: "G-LJEF344295"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM elements
        const logoutBtn = document.getElementById('logoutBtn');
        const profileAvatar = document.getElementById('profileAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhone = document.getElementById('userPhone');
        const accountLink = document.getElementById('accountLink');
        const completionProgress = document.getElementById('completionProgress');
        const completionPercent = document.getElementById('completionPercent');
        
        // Profile edit elements
        const avatarEdit = document.getElementById('avatarEdit');
        const profilePhotoInput = document.getElementById('profilePhotoInput');
        
        // Personal info elements
        const editPersonalInfo = document.getElementById('editPersonalInfo');
        const personalInfoForm = document.getElementById('personalInfoForm');
        const savePersonalInfo = document.getElementById('savePersonalInfo');
        const cancelPersonalInfo = document.getElementById('cancelPersonalInfo');
        const displayName = document.getElementById('displayName');
        const displayEmail = document.getElementById('displayEmail');
        const displayPhone = document.getElementById('displayPhone');
        const displayAddress = document.getElementById('displayAddress');
        const editName = document.getElementById('editName');
        const editPhone = document.getElementById('editPhone');
        const editAddress = document.getElementById('editAddress');
        
        // License elements
        const editLicense = document.getElementById('editLicense');
        const licenseForm = document.getElementById('licenseForm');
        const saveLicense = document.getElementById('saveLicense');
        const cancelLicense = document.getElementById('cancelLicense');
        const licenseStatus = document.getElementById('licenseStatus');
        
        // Payment elements
        const editPayment = document.getElementById('editPayment');
        const paymentForm = document.getElementById('paymentForm');
        const savePayment = document.getElementById('savePayment');
        const cancelPayment = document.getElementById('cancelPayment');
        
        // Notification system
        function showNotification(message, isSuccess = true) {
            const notification = document.createElement('div');
            notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="close-notification">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            const timer = setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 2000);
            
            notification.querySelector('.close-notification').addEventListener('click', () => {
                clearTimeout(timer);
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            });
        }

        // Calculate profile completion percentage
        function calculateProfileCompletion(userData) {
            let completedFields = 0;
            const totalFields = 5; // name, email, phone, address, license
            
            if (userData.name) completedFields++;
            if (userData.email) completedFields++;
            if (userData.phone) completedFields++;
            if (userData.address) completedFields++;
            if (userData.licenseVerified) completedFields++;
            
            const percentage = Math.round((completedFields / totalFields) * 100);
            return percentage;
        }

        // Update profile completion UI
        function updateProfileCompletion(percentage) {
            completionProgress.style.width = `${percentage}%`;
            completionPercent.textContent = `${percentage}%`;
        }

        // Validate phone number
        function validatePhoneNumber(phone) {
            const regex = /^\+?[\d\s\-\(\)]{8,}$/;
            return regex.test(phone);
        }

        // Validate email
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // Validate name
        function validateName(name) {
            return name.trim().length >= 2;
        }

        // Check auth state and load user data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Get user data from Firestore
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        // Display user info
                        userName.textContent = userData.name || user.email;
                        userEmail.textContent = user.email;
                        displayName.textContent = userData.name || 'Not provided';
                        displayEmail.textContent = user.email;
                        
                        if (userData.phone) {
                            userPhone.textContent = userData.phone;
                            displayPhone.textContent = userData.phone;
                            userPhone.classList.remove('empty-value');
                        } else {
                            userPhone.textContent = 'No phone number added';
                            displayPhone.textContent = 'Not provided';
                            userPhone.classList.add('empty-value');
                        }
                        
                        if (userData.address) {
                            displayAddress.textContent = userData.address;
                        } else {
                            displayAddress.textContent = 'Not provided';
                            displayAddress.classList.add('empty-value');
                        }
                        
                        if (userData.profilePic) {
                            profileAvatar.src = userData.profilePic;
                        } else {
                            // Default avatar if no profile picture
                            profileAvatar.src = "images/default-avatar.png";
                        }
                        
                        // Update license status
                        if (userData.licenseVerified) {
                            licenseStatus.textContent = 'Verified';
                            licenseStatus.style.color = 'var(--primary-green)';
                            editLicense.textContent = 'View License';
                        } else if (userData.licenseSubmitted) {
                            licenseStatus.textContent = 'Under Review';
                            licenseStatus.style.color = 'var(--accent-yellow)';
                            editLicense.textContent = 'View Details';
                        } else {
                            licenseStatus.textContent = 'Not verified';
                            licenseStatus.style.color = 'var(--text-light)';
                            editLicense.textContent = 'Add License';
                        }
                        
                        // Calculate and update profile completion
                        const completionPercentage = calculateProfileCompletion(userData);
                        updateProfileCompletion(completionPercentage);
                        
                        // Pre-fill edit forms
                        editName.value = userData.name || '';
                        editPhone.value = userData.phone || '';
                        editAddress.value = userData.address || '';
                        
                    } else {
                        // Create user document if it doesn't exist
                        await setDoc(userDocRef, {
                            userId: user.uid,
                            email: user.email,
                            name: user.displayName || '',
                            phone: '',
                            profilePic: user.photoURL || '',
                            address: '',
                            licenseVerified: false,
                            licenseSubmitted: false,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        });
                        
                        showNotification('Profile created successfully!');
                    }
                } catch (error) {
                    console.error("Error getting user data:", error);
                    showNotification('Error loading profile data. Please try again.', false);
                }
            } else {
                // No user is signed in, redirect to index.html
                window.location.href = "index.html";
            }
        });

        // Logout button
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // Redirect happens automatically via the auth state listener
            } catch (error) {
                console.error("Error signing out:", error);
                showNotification('Error signing out. Please try again.', false);
            }
        });

        // Account link - just prevent default and do nothing (we're already on account page)
        accountLink.addEventListener('click', (e) => {
            e.preventDefault();
        });

        // Mobile menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menuToggle');
            const navLinks = document.getElementById('navLinks');

            if (menuToggle && navLinks) {
                menuToggle.addEventListener('click', () => {
                    navLinks.classList.toggle('active');
                });

                document.addEventListener('click', (e) => {
                    if (!navLinks.contains(e.target) && !menuToggle.contains(e.target)) {
                        if (window.innerWidth <= 768) {
                            navLinks.classList.remove('active');
                        }
                    }
                });
            }
        });

        // Profile photo upload
        avatarEdit.addEventListener('click', () => {
            profilePhotoInput.click();
        });

        profilePhotoInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                // Upload to Firebase Storage
                const storageRef = ref(storage, `profile_pictures/${user.uid}`);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                // Update profile picture in Firebase Auth
                await updateProfile(user, {
                    photoURL: downloadURL
                });
                
                // Update profile picture in Firestore
                const userDocRef = doc(db, "users", user.uid);
                await updateDoc(userDocRef, {
                    profilePic: downloadURL,
                    updatedAt: serverTimestamp()
                });
                
                // Update UI
                profileAvatar.src = downloadURL;
                showNotification('Profile picture updated successfully!');
                
                // Recalculate profile completion
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const completionPercentage = calculateProfileCompletion(userDoc.data());
                    updateProfileCompletion(completionPercentage);
                }
                
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                showNotification('Failed to update profile picture. Please try again.', false);
            }
        });

        // Personal Info Edit
        editPersonalInfo.addEventListener('click', () => {
            personalInfoForm.style.display = 'block';
        });

        cancelPersonalInfo.addEventListener('click', () => {
            personalInfoForm.style.display = 'none';
        });

        savePersonalInfo.addEventListener('click', async () => {
            const name = editName.value.trim();
            const phone = editPhone.value.trim();
            const address = editAddress.value.trim();
            
            // Validate inputs
            if (!validateName(name)) {
                showNotification('Please enter a valid name (at least 2 characters)', false);
                return;
            }
            
            if (phone && !validatePhoneNumber(phone)) {
                showNotification('Please enter a valid phone number', false);
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                const userDocRef = doc(db, "users", user.uid);
                
                // Update user data in Firestore
                await updateDoc(userDocRef, {
                    name: name,
                    phone: phone || null,
                    address: address || null,
                    updatedAt: serverTimestamp()
                });
                
                // Update UI
                displayName.textContent = name;
                
                if (phone) {
                    displayPhone.textContent = phone;
                    userPhone.textContent = phone;
                    userPhone.classList.remove('empty-value');
                } else {
                    displayPhone.textContent = 'Not provided';
                    userPhone.textContent = 'No phone number added';
                    userPhone.classList.add('empty-value');
                }
                
                if (address) {
                    displayAddress.textContent = address;
                    displayAddress.classList.remove('empty-value');
                } else {
                    displayAddress.textContent = 'Not provided';
                    displayAddress.classList.add('empty-value');
                }
                
                // Hide form
                personalInfoForm.style.display = 'none';
                
                // Update profile completion
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const completionPercentage = calculateProfileCompletion(userDoc.data());
                    updateProfileCompletion(completionPercentage);
                }
                
                showNotification('Profile updated successfully!');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Failed to update profile. Please try again.', false);
            }
        });

        // License Edit
        editLicense.addEventListener('click', () => {
            licenseForm.style.display = 'block';
        });

        cancelLicense.addEventListener('click', () => {
            licenseForm.style.display = 'none';
        });

        saveLicense.addEventListener('click', async () => {
            const licenseNumber = document.getElementById('licenseNumber').value.trim();
            const licenseState = document.getElementById('licenseState').value.trim();
            const licenseExpiry = document.getElementById('licenseExpiry').value;
            const licenseFront = document.getElementById('licenseFront').files[0];
            const licenseBack = document.getElementById('licenseBack').files[0];
            
            // Validate inputs
            if (!licenseNumber || !licenseState || !licenseExpiry) {
                showNotification('Please fill all required fields', false);
                return;
            }
            
            if (!licenseFront || !licenseBack) {
                showNotification('Please upload both front and back of your license', false);
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                const userDocRef = doc(db, "users", user.uid);
                
                // Upload license images to storage
                const frontRef = ref(storage, `licenses/${user.uid}/front_${Date.now()}`);
                const backRef = ref(storage, `licenses/${user.uid}/back_${Date.now()}`);
                
                const [frontSnapshot, backSnapshot] = await Promise.all([
                    uploadBytes(frontRef, licenseFront),
                    uploadBytes(backRef, licenseBack)
                ]);
                
                const [frontURL, backURL] = await Promise.all([
                    getDownloadURL(frontSnapshot.ref),
                    getDownloadURL(backSnapshot.ref)
                ]);
                
                // Update user data in Firestore
                await updateDoc(userDocRef, {
                    licenseNumber: licenseNumber,
                    licenseState: licenseState,
                    licenseExpiry: licenseExpiry,
                    licenseFront: frontURL,
                    licenseBack: backURL,
                    licenseSubmitted: true,
                    licenseVerified: false,
                    updatedAt: serverTimestamp()
                });
                
                // Update UI
                licenseStatus.textContent = 'Under Review';
                licenseStatus.style.color = 'var(--accent-yellow)';
                editLicense.textContent = 'View Details';
                licenseForm.style.display = 'none';
                
                // Update profile completion
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const completionPercentage = calculateProfileCompletion(userDoc.data());
                    updateProfileCompletion(completionPercentage);
                }
                
                showNotification('License submitted for verification!');
                
            } catch (error) {
                console.error('Error submitting license:', error);
                showNotification('Failed to submit license. Please try again.', false);
            }
        });

        // Payment Edit
        editPayment.addEventListener('click', () => {
            paymentForm.style.display = 'block';
        });

        cancelPayment.addEventListener('click', () => {
            paymentForm.style.display = 'none';
        });

        savePayment.addEventListener('click', async () => {
            const cardNumber = document.getElementById('cardNumber').value.trim();
            const cardName = document.getElementById('cardName').value.trim();
            const cardExpiry = document.getElementById('cardExpiry').value.trim();
            const cardCvv = document.getElementById('cardCvv').value.trim();
            
            // Validate inputs (basic validation)
            if (!cardNumber || !cardName || !cardExpiry || !cardCvv) {
                showNotification('Please fill all required fields', false);
                return;
            }
            
            if (cardNumber.length < 16) {
                showNotification('Please enter a valid card number', false);
                return;
            }
            
            if (cardCvv.length < 3) {
                showNotification('Please enter a valid CVV', false);
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                const userDocRef = doc(db, "users", user.uid);
                
                // In a real app, you would use a payment processor API here
                // For demo purposes, we'll just store the last 4 digits
                const last4 = cardNumber.slice(-4);
                
                await updateDoc(userDocRef, {
                    paymentMethod: {
                        type: 'card',
                        last4: last4,
                        name: cardName,
                        expiry: cardExpiry
                    },
                    updatedAt: serverTimestamp()
                });
                
                // Update UI
                paymentForm.style.display = 'none';
                showNotification('Payment method added successfully!');
                
            } catch (error) {
                console.error('Error adding payment method:', error);
                showNotification('Failed to add payment method. Please try again.', false);
            }
        });
    </script>
</body>
</html>