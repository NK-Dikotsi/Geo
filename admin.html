<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GeoCarRental</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #2962FF;
            --primary-green: #00C853;
            --accent-yellow: #FFD600;
            --accent-orange: #FFAB40;
            --text-dark: #212121;
            --text-light: #757575;
            --bg-white: #FFFFFF;
            --bg-light: #f5f7fa;
            --border-radius: 8px;
        }
    
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
    
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        /* Auth Check Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .auth-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-logo {
            height: 80px;
            margin-bottom: 1.5rem;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Dashboard Styles */
        #adminDashboard {
            display: none;
            padding: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-blue);
        }

        .table-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.pending {
            background: #FFF3E0;
            color: #E65100;
        }

        .status-badge.active {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .table-btn {
            border: none;
            background: none;
            cursor: pointer;
            margin: 0 5px;
            font-size: 1rem;
        }

        .table-btn.primary {
            color: var(--primary-blue);
        }

        .table-btn.success {
            color: var(--primary-green);
        }

        .table-btn.danger {
            color: #F44336;
        }

        .user-cell {
            display: flex;
            align-items: center;
        }

        .table-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        /* Add more styles as needed */
    </style>
</head>
<body>
    <!-- Auth Check Container -->
    <div id="authCheckContainer" class="auth-container">
        <div class="auth-card">
            <img src="images/logoblack1.png" alt="Logo" class="auth-logo">
            <div class="auth-title">Verifying Admin Access</div>
            <div>Please wait while we verify your admin privileges...</div>
            <div style="margin-top: 1rem;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary-blue);"></i>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <button id="logoutBtn">Logout</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Users</div>
                <div class="stat-value">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Cars</div>
                <div class="stat-value">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Bookings</div>
                <div class="stat-value">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pending Approvals</div>
                <div class="stat-value">0</div>
            </div>
        </div>

        <div class="table-section">
            <h2>Pending Approvals</h2>
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Type</th>
                        <th>Date Submitted</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="table-section">
            <h2>Recent Users</h2>
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Join Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { 
            getAuth, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection,
            query,
            where,
            getDocs,
            doc,
            getDoc,
            updateDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAMU2y175sXjHkxAv6SF88-E9FCjaR2kJc",
            authDomain: "geocarrental-9a4de.firebaseapp.com",
            projectId: "geocarrental-9a4de",
            storageBucket: "geocarrental-9a4de.appspot.com",
            messagingSenderId: "951760186950",
            appId: "1:951760186950:web:7e8cc25aacdd251f152447",
            measurementId: "G-LJEF344295"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const authCheckContainer = document.getElementById('authCheckContainer');
        const adminDashboard = document.getElementById('adminDashboard');
        const logoutBtn = document.getElementById('logoutBtn');

        // Check admin status
        onAuthStateChanged(auth, async (user) => {
            if (user && user.email === 'admin@geo.com') {
                // Verify admin role in Firestore
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    authCheckContainer.style.display = 'none';
                    adminDashboard.style.display = 'block';
                    initializeDashboard();
                } else {
                    await signOut(auth);
                    window.location.href = "index.html";
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                await loadStats();
                await loadPendingApprovals();
                await loadRecentUsers();
                setupEventListeners();
            } catch (error) {
                console.error("Dashboard init error:", error);
                showNotification("Failed to load dashboard data", false);
            }
        }

        // Load statistics
        async function loadStats() {
            const [
                usersSnapshot, 
                carsSnapshot, 
                bookingsSnapshot,
                pendingLicensesSnapshot,
                pendingCarsSnapshot
            ] = await Promise.all([
                getDocs(collection(db, "users")),
                getDocs(query(collection(db, "cars"), where("approved", "==", true))),
                getDocs(query(collection(db, "bookings"), where("status", "==", "active"))),
                getDocs(query(collection(db, "users"), 
                    where("licenseSubmitted", "==", true), 
                    where("licenseVerified", "==", false))),
                getDocs(query(collection(db, "cars"), where("approved", "==", false)))
            ]);

            document.querySelectorAll('.stat-value')[0].textContent = usersSnapshot.size;
            document.querySelectorAll('.stat-value')[1].textContent = carsSnapshot.size;
            document.querySelectorAll('.stat-value')[2].textContent = bookingsSnapshot.size;
            document.querySelectorAll('.stat-value')[3].textContent = 
                pendingLicensesSnapshot.size + pendingCarsSnapshot.size;
        }

        // Load pending approvals
        async function loadPendingApprovals() {
            const tbody = document.querySelector('.table-section tbody');
            tbody.innerHTML = '';

            const [pendingLicenses, pendingCars] = await Promise.all([
                getDocs(query(collection(db, "users"), 
                    where("licenseSubmitted", "==", true), 
                    where("licenseVerified", "==", false))),
                getDocs(query(collection(db, "cars"), where("approved", "==", false)))
            ]);

            // Process licenses
            pendingLicenses.forEach(doc => {
                const data = doc.data();
                tbody.appendChild(createApprovalRow({
                    id: doc.id,
                    type: 'license',
                    user: data,
                    date: data.licenseSubmittedAt?.toDate() || new Date()
                }));
            });

            // Process cars
            pendingCars.forEach(async doc => {
                const carData = doc.data();
                const ownerDoc = await getDoc(doc(db, "users", carData.ownerId));
                tbody.appendChild(createApprovalRow({
                    id: doc.id,
                    type: 'car',
                    user: ownerDoc.data(),
                    car: carData,
                    date: carData.createdAt?.toDate() || new Date()
                }));
            });

            if (pendingLicenses.size === 0 && pendingCars.size === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No pending approvals</td></tr>`;
            }
        }

        // Create approval row
        function createApprovalRow(data) {
            const row = document.createElement('tr');
            const dateStr = data.date.toLocaleDateString();
            
            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <img src="${data.user.profilePic || 'images/default-avatar.png'}" class="table-avatar">
                        <div>${data.user.name || 'No name'}<br>${data.user.email}</div>
                    </div>
                </td>
                <td>${data.type === 'license' ? 'Driver License' : 'Car Listing'}</td>
                <td>${dateStr}</td>
                <td><span class="status-badge pending">Pending</span></td>
                <td>
                    <button class="table-btn primary" onclick="view${data.type === 'license' ? 'License' : 'Car'}Approval('${data.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="table-btn success" onclick="approve${data.type === 'license' ? 'License' : 'Car'}('${data.id}')">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="table-btn danger" onclick="reject${data.type === 'license' ? 'License' : 'Car'}('${data.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // Load recent users
        async function loadRecentUsers() {
            const tbody = document.querySelectorAll('.table-section tbody')[1];
            tbody.innerHTML = '';

            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const usersSnapshot = await getDocs(query(
                collection(db, "users"),
                where("createdAt", ">=", oneWeekAgo),
                where("email", "!=", "admin@geo.com")
            ));

            usersSnapshot.forEach(doc => {
                const data = doc.data();
                tbody.appendChild(createUserRow(doc.id, data));
            });

            if (usersSnapshot.size === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No recent users</td></tr>`;
            }
        }

        // Create user row
        function createUserRow(id, data) {
            const row = document.createElement('tr');
            const dateStr = data.createdAt?.toDate().toLocaleDateString() || 'Unknown';
            
            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <img src="${data.profilePic || 'images/default-avatar.png'}" class="table-avatar">
                        <div>${data.name || 'No name'}<br>${data.email}</div>
                    </div>
                </td>
                <td>${data.role || 'renter'}</td>
                <td>${dateStr}</td>
                <td><span class="status-badge active">Active</span></td>
                <td>
                    <button class="table-btn primary" onclick="viewUserDetails('${id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="table-btn" onclick="editUser('${id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // Setup event listeners
        function setupEventListeners() {
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    window.location.href = "index.html";
                } catch (error) {
                    console.error("Logout error:", error);
                    showNotification("Logout failed", false);
                }
            });
        }

        // Approval functions
        async function approveLicense(userId) {
            try {
                await updateDoc(doc(db, "users", userId), {
                    licenseVerified: true,
                    licenseSubmitted: false,
                    updatedAt: serverTimestamp()
                });
                showNotification("License approved");
                await Promise.all([loadStats(), loadPendingApprovals()]);
            } catch (error) {
                console.error("Approve license error:", error);
                showNotification("Approval failed", false);
            }
        }

        async function rejectLicense(userId) {
            try {
                await updateDoc(doc(db, "users", userId), {
                    licenseVerified: false,
                    licenseSubmitted: false,
                    updatedAt: serverTimestamp()
                });
                showNotification("License rejected");
                await Promise.all([loadStats(), loadPendingApprovals()]);
            } catch (error) {
                console.error("Reject license error:", error);
                showNotification("Rejection failed", false);
            }
        }

        async function approveCar(carId) {
            try {
                await updateDoc(doc(db, "cars", carId), {
                    approved: true,
                    updatedAt: serverTimestamp()
                });
                showNotification("Car approved");
                await Promise.all([loadStats(), loadPendingApprovals()]);
            } catch (error) {
                console.error("Approve car error:", error);
                showNotification("Approval failed", false);
            }
        }

        async function rejectCar(carId) {
            try {
                await updateDoc(doc(db, "cars", carId), {
                    approved: false,
                    isAvailable: false,
                    updatedAt: serverTimestamp()
                });
                showNotification("Car rejected");
                await Promise.all([loadStats(), loadPendingApprovals()]);
            } catch (error) {
                console.error("Reject car error:", error);
                showNotification("Rejection failed", false);
            }
        }

        // View functions
        function viewLicenseApproval(userId) {
            window.location.href = `license-approval.html?id=${userId}`;
        }

        function viewCarApproval(carId) {
            window.location.href = `car-approval.html?id=${carId}`;
        }

        function viewUserDetails(userId) {
            window.location.href = `user-details.html?id=${userId}`;
        }

        // Notification function
        function showNotification(message, isSuccess = true) {
            const notification = document.createElement('div');
            notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Expose functions to window
        window.approveLicense = approveLicense;
        window.rejectLicense = rejectLicense;
        window.approveCar = approveCar;
        window.rejectCar = rejectCar;
        window.viewLicenseApproval = viewLicenseApproval;
        window.viewCarApproval = viewCarApproval;
        window.viewUserDetails = viewUserDetails;
        window.editUser = function(id) {
            console.log("Edit user:", id);
        };
    </script>
</body>
</html>