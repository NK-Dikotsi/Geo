<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - MetroShift</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --primary-blue: #2962FF;
        --primary-green: #00C853;
        --accent-yellow: #FFD600;
        --accent-orange: #FFAB40;
        --text-dark: #212121;
        --text-light: #757575;
        --bg-white: #FFFFFF;
        --bg-black: #121212;
        --border-radius: 8px;
        --transition: all 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Poppins', sans-serif;
        color: var(--text-dark);
        line-height: 1.6;
        background-color: whitesmoke;
    }

    .navbar {
        background-color: var(--bg-white);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1rem 5%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
        height: 80px;
    }

    .navbar-logo-container {
        height: 80px;
        display: flex;
        align-items: center;
        margin-right: auto;
    }

    .navbar-logo {
        height: 160px;
        width: auto;
        max-height: 100%;
        object-fit: contain;
    }

    .nav-links {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .auth-button {
        text-decoration: none;
        color: var(--text-dark);
        font-weight: 600;
        font-size: 0.95rem;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        transition: var(--transition);
    }

    .auth-button:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .auth-button.my-rides {
        color: #212121;
    }

    .host-button {
        text-decoration: none;
        color: white;
        background-color: #2962ff;
        font-weight: 600;
        font-size: 0.95rem;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        border: 1px solid #2962ff;
        transition: var(--transition);
    }

    .host-button:hover {
        background-color: #1a4fd8;
        border-color: #1a4fd8;
    }

    /* Mobile Menu Toggle */
    .menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-dark);
    }

    /* Account Container */
    .account-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 5%;
    }
    
    .account-header {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .account-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1.5rem;
        overflow: hidden;
        position: relative;
    }
    
    .account-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .avatar-edit {
        position: absolute;
        bottom: 0;
        right: 0;
        background: var(--primary-blue);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .account-info {
        flex: 1;
        min-width: 250px;
    }
    
    .account-info h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
    }
    
    .account-info p {
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }
    
    .profile-completion {
        width: 100%;
        margin-top: 1rem;
    }
    
    .completion-bar {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        overflow: hidden;
    }
    
    .completion-progress {
        height: 100%;
        background: var(--primary-blue);
        width: 0%;
        transition: width 0.5s ease;
    }
    
    .completion-text {
        font-size: 0.85rem;
        color: var(--text-light);
    }

    .account-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
        transition: var(--transition);
    }

    .account-avatar img:hover {
        opacity: 0.9;
    }
    
    .completion-text strong {
        color: var(--primary-blue);
    }
    
    /* Account Sections */
    .account-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .account-section h2 {
        font-size: 1.3rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .section-edit {
        font-size: 0.9rem;
        color: var(--primary-blue);
        cursor: pointer;
        font-weight: 500;
    }
    
    .section-content {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
    }
    
    .info-group {
        min-width: 200px;
    }
    
    .info-label {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-bottom: 0.25rem;
    }
    
    .info-value {
        font-weight: 500;
    }
    
    .empty-value {
        color: var(--text-light);
        font-style: italic;
    }
    
    /* Edit Forms */
    .edit-form {
        display: none;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #eee;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group input, 
    .form-group select, 
    .form-group textarea {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
    }
    
    .form-group input:focus, 
    .form-group select:focus, 
    .form-group textarea:focus {
        border-color: var(--primary-blue);
        outline: none;
        box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.2);
    }
    
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .save-btn, .cancel-btn {
        padding: 0.8rem 1.5rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .save-btn {
        background-color: var(--primary-blue);
        color: white;
        border: none;
    }
    
    .save-btn:hover {
        background-color: #1a4fd8;
    }
    
    .cancel-btn {
        background: none;
        border: 1px solid #ddd;
    }
    
    .cancel-btn:hover {
        background: #f5f5f5;
    }
    
    /* Profile Photo Upload */
    #profilePhotoInput {
        display: none;
    }
    
    /* Cars Section */
    .cars-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }
    
    .car-card {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transition: var(--transition);
        position: relative;
    }
    
    .car-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .car-image {
        height: 180px;
        width: 100%;
        object-fit: cover;
    }
    
    .car-details {
        padding: 1.2rem;
    }
    
    .car-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .car-price {
        color: var(--primary-blue);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .car-specs {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }
    
    .car-spec {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        color: var(--text-light);
    }
    
    .car-spec i {
        margin-right: 0.3rem;
        font-size: 0.9rem;
    }
    
    .car-location {
        font-size: 0.85rem;
        color: var(--text-light);
        display: flex;
        align-items: center;
        margin-top: 0.5rem;
    }
    
    .car-location i {
        margin-right: 0.5rem;
        color: var(--primary-blue);
    }

    .car-status {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .car-status.available {
        background-color: var(--primary-green);
        color: white;
    }

    .car-status.unavailable {
        background-color: #f44336;
        color: white;
    }

    .car-status.pending {
        background-color: var(--accent-yellow);
        color: var(--text-dark);
    }
    
    .no-cars {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
        grid-column: 1 / -1;
    }
    
    .no-cars-video {
        max-width: 400px;
        margin-bottom: 1rem;
        border-radius: var(--border-radius);
    }
    
    .no-cars p {
        color: var(--text-light);
        margin-bottom: 1rem;
    }
    
    .explore-btn {
        padding: 0.8rem 1.5rem;
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: var(--transition);
    }
    
    .explore-btn:hover {
        background-color: #1a4fd8;
    }

    .add-car-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.8rem 1.5rem;
        background-color: var(--primary-green);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 1.5rem;
        transition: var(--transition);
    }

    .add-car-btn:hover {
        background-color: #00b247;
    }

    /* Add Car Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 600px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        position: relative;
    }

    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 1.5rem;
        color: var(--text-light);
        cursor: pointer;
    }

    .close-modal:hover {
        color: var(--text-dark);
    }

    .modal-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: var(--primary-blue);
    }

    .image-upload-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .image-upload-preview {
        width: 100px;
        height: 100px;
        border: 2px dashed #ddd;
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }

    .image-upload-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-upload-preview .upload-icon {
        font-size: 2rem;
        color: var(--text-light);
    }

    .image-upload-preview input {
        display: none;
    }

    .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(255, 0, 0, 0.7);
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        cursor: pointer;
    }

    .availability-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .availability-container .form-group {
        flex: 1;
        margin-bottom: 0;
    }

    /* Location Autocomplete */
    .autocomplete-container {
        position: relative;
    }

    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .autocomplete-result {
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .autocomplete-result:hover {
        background-color: #f5f5f5;
    }

    /* Image Modal */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        overflow: auto;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content-img {
        display: block;
        margin: auto;
        max-width: 90%;
        max-height: 90%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 4px;
    }

    .close-img-modal {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 35px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1002;
    }

    .close-img-modal:hover {
        color: #ccc;
    }
    
    /* Loading State */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Notification Styles - UPDATED */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 60px 20px 15px 20px;
        border-radius: 8px;
        color: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        max-width: 400px;
        z-index: 9999;
        transform: translateX(120%);
        transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        min-height: 120px;
        text-align: center;
    }
    
    .notification.show {
        transform: translateX(0);
    }
    
    .notification.success {
        background-color: #2962FF;
    }
    
    .notification.error {
        background-color: #F44336;
    }
    
    .notification.fade-out {
        transform: translateX(120%);
    }
    
    .notification-logo {
        position: absolute;
        top: 15px;
        width: 40px;
        height: 40px;
        object-fit: contain;
    }
    
    .notification-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }
    
    .close-notification {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        margin-left: 15px;
        padding: 0;
        opacity: 0.8;
        transition: opacity 0.2s ease;
        flex-shrink: 0;
    }
    
    .close-notification:hover {
        opacity: 1;
    }
    
    .notification-message {
        flex-grow: 1;
        text-align: left;
    }
    
    @media (max-width: 768px) {
        .menu-toggle {
            display: block;
        }

        .nav-links {
            position: fixed;
            top: 80px;
            left: 0;
            width: 100%;
            background-color: var(--bg-white);
            flex-direction: column;
            align-items: flex-start;
            padding: 1rem 5%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            gap: 1rem;
            transform: translateY(-150%);
            transition: var(--transition);
            z-index: 999;
        }

        .nav-links.active {
            transform: translateY(0);
        }

        .host-button, .auth-button, .logout-btn {
            border: none;
            padding: 0.5rem 0;
            width: 100%;
            text-align: left;
        }

        .host-button {
            background-color: transparent;
            color: var(--primary-blue);
            border: none;
        }

        .account-avatar {
            width: 80px;
            height: 80px;
            margin-right: 1rem;
        }
        
        .account-info h1 {
            font-size: 1.5rem;
        }
        
        .account-section {
            padding: 1.5rem;
        }
        
        .section-content {
            gap: 1.5rem;
        }

        .modal-content {
            margin: 10% auto;
            width: 95%;
            padding: 1.5rem;
        }

        .availability-container {
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Notification adjustments for mobile */
        .notification {
            right: 10px;
            left: 10px;
            max-width: none;
        }
    }
    
    @media (max-width: 480px) {
        .account-avatar {
            width: 70px;
            height: 70px;
        }
        
        .account-info h1 {
            font-size: 1.3rem;
        }
        
        .account-section h2 {
            font-size: 1.1rem;
        }
        
        .nav-links {
            width: 100%;
        }
    }
    
    .logout-btn {
        background: none;
        border: none;
        color: var(--text-dark);
        font-weight: 600;
        font-size: 0.95rem;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        cursor: pointer;
        transition: var(--transition);
    }

    .logout-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    /* Overlay for mobile menu */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: var(--transition);
    }

    .overlay.active {
        opacity: 1;
        visibility: visible;
    }
</style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-logo-container">
            <a href="index.html">
                <img src="images/logoblack1.png" alt="GeoCarRental Logo" class="navbar-logo">
            </a>
        </div>
        
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="nav-links" id="navLinks">
            <a href="index.html" class="auth-button">Home</a>
            <a href="#" class="host-button">Owner Dashboard</a>
            <button class="logout-btn" id="logoutBtn">Log Out</button>
        </div>
    </nav>

    <!-- Overlay for mobile menu -->
    <div class="overlay" id="overlay"></div>

    <!-- Account Content -->
    <main class="account-container">
        <div class="account-header">
            <div class="account-avatar">
                <img src="" alt="Profile" id="profileAvatar">
                <div class="avatar-edit" id="avatarEdit">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="profilePhotoInput" accept="image/*">
                </div>
            </div>
            <div class="account-info">
                <h1 id="userName">Loading...</h1>
                <p id="userEmail">Loading...</p>
                <p id="userPhone" class="empty-value">No phone number added</p>
                
                <div class="profile-completion">
                    <div class="completion-bar">
                        <div class="completion-progress" id="completionProgress"></div>
                    </div>
                    <p class="completion-text">Profile is <strong id="completionPercent">0%</strong> complete</p>
                </div>
            </div>
        </div>

        <!-- Owner Approval Status -->
        <div class="account-section" id="ownerApprovalSection">
            <h2>Owner Status</h2>
            <div class="section-content">
                <div class="info-group">
                    <p class="info-label">Approval Status</p>
                    <p class="info-value" id="ownerApprovalStatus">Pending Approval</p>
                </div>
                <div class="info-group">
                    <p class="info-label">Earnings</p>
                    <p class="info-value" id="ownerEarnings">R0.00</p>
                </div>
                <div class="info-group">
                    <p class="info-label">Listings</p>
                    <p class="info-value" id="ownerListings">0 cars</p>
                </div>
            </div>
        </div>

        <div class="account-section">
            <h2>
                My Bookings
                <span class="section-edit" id="editPayment">View Bookings</span>
            </h2>
            
            <div class="section-content">
                <div class="info-group">
                    <p class="info-value empty-value">No Bookings</p>
                </div>
            </div>
        </div>
            
        <!-- My Cars Section -->
        <div class="account-section">
            <h2>
                My Cars
                <button class="add-car-btn" id="addCarBtn">
                    <i class="fas fa-plus"></i> Add New Car
                </button>
            </h2>
            <div class="cars-container" id="carsContainer">
                <div class="no-cars">
                    <img src="videos/nocars.gif" alt="No cars available" class="no-cars-video">
                    <p>You haven't listed any cars yet.</p>
                </div>
            </div>
        </div>
        
        <!-- Personal Info Section -->
        <div class="account-section">
            <h2>
                Personal Information
                <span class="section-edit" id="editPersonalInfo">Edit</span>
            </h2>
            
            <div class="section-content">
                <div class="info-group">
                    <p class="info-label">Full Name</p>
                    <p class="info-value" id="displayName"></p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Email</p>
                    <p class="info-value" id="displayEmail"></p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Phone</p>
                    <p class="info-value" id="displayPhone"></p>
                </div>
                
                <div class="info-group">
                    <p class="info-label">Location</p>
                    <p class="info-value" id="displayLocation">Detecting your location...</p>
                </div>
            </div>
            
            <!-- Edit Personal Info Form -->
            <div class="edit-form" id="personalInfoForm">
                <div class="form-group">
                    <label for="editName">Full Name</label>
                    <input type="text" id="editName" required>
                </div>
                
                <div class="form-group">
                    <label for="editPhone">Phone Number</label>
                    <input type="tel" id="editPhone" placeholder="+1 (555) 123-4567">
                </div>
                
                <div class="form-group">
                    <label>Location</label>
                    <button type="button" class="save-btn" id="updateLocation" style="width: 100%;">
                        <span id="locationBtnText">Update My Location</span>
                    </button>
                    <p id="locationStatus" style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--text-light);"></p>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="save-btn" id="savePersonalInfo">Save Changes</button>
                    <button type="button" class="cancel-btn" id="cancelPersonalInfo">Cancel</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Car Modal -->
    <div class="modal" id="addCarModal">
        <div class="modal-content">
            <span class="close-modal" id="closeCarModal">&times;</span>
            <h2 class="modal-title">Add New Car</h2>
            
            <div class="form-group">
                <label for="carMake">Make</label>
                <input type="text" id="carMake" placeholder="Toyota" required>
            </div>
            
            <div class="form-group">
                <label for="carModel">Model</label>
                <input type="text" id="carModel" placeholder="Corolla" required>
            </div>
            
            <div class="form-group">
                <label for="carYear">Year</label>
                <input type="number" id="carYear" min="1900" max="2025" placeholder="2022" required>
            </div>
            
            <div class="form-group">
                <label for="carColor">Color</label>
                <input type="text" id="carColor" placeholder="Blue" required>
            </div>
            
            <div class="form-group">
                <label for="carLicensePlate">License Plate</label>
                <input type="text" id="carLicensePlate" placeholder="ABC123" required>
            </div>
            
            <div class="form-group">
                <label for="carPrice">Price per Day (R)</label>
                <input type="number" id="carPrice" min="100" placeholder="500" required>
            </div>
            
            <div class="form-group">
                <label for="carFuelType">Fuel Type</label>
                <select id="carFuelType" required>
                    <option value="">Select fuel type</option>
                    <option value="Petrol">Petrol</option>
                    <option value="Diesel">Diesel</option>
                    <option value="Hybrid">Hybrid</option>
                    <option value="Electric">Electric</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="carFuelEfficiency">Fuel Efficiency (litres per 10km)</label>
                <input type="number" id="carFuelEfficiency" min="0" step="0.1" placeholder="1.2" required>
                <small style="color: var(--text-light);">For electric vehicles, enter 0</small>
            </div>
            
            <div class="form-group">
                <label>Upload Images (Max 5)</label>
                <div class="image-upload-container" id="imageUploadContainer">
                    <!-- Image upload boxes will be added here dynamically -->
                </div>
            </div>
            
            <div class="form-group autocomplete-container">
                <label for="carLocation">Location</label>
                <input type="text" id="carLocation" placeholder="Enter car location" required>
                <div class="autocomplete-results" id="locationAutocomplete"></div>
                <input type="hidden" id="carLocationLat">
                <input type="hidden" id="carLocationLon">
            </div>
            
            <div class="availability-container">
                <div class="form-group">
                    <label for="availabilityStart">Available From</label>
                    <input type="date" id="availabilityStart" required>
                </div>
                <div class="form-group">
                    <label for="availabilityEnd">Available To</label>
                    <input type="date" id="availabilityEnd" required>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="save-btn" id="saveCarBtn">List My Car</button>
                <button type="button" class="cancel-btn" id="cancelCarBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Image View Modal -->
    <div class="image-modal" id="imageModal">
        <span class="close-img-modal">&times;</span>
        <img class="modal-content-img" id="modalImage">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            serverTimestamp,
            collection,
            query,
            where,
            getDocs,
            addDoc
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAMU2y175sXjHkxAv6SF88-E9FCjaR2kJc",
            authDomain: "geocarrental-9a4de.firebaseapp.com",
            projectId: "geocarrental-9a4de",
            storageBucket: "geocarrental-9a4de.appspot.com",
            messagingSenderId: "951760186950",
            appId: "1:951760186950:web:7e8cc25aacdd251f152447",
            measurementId: "G-LJEF344295"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Geoapify API Key
        const GEOAPIFY_API_KEY = "2ca9e48dc90443978775d9ef8792b96e";

        // DOM elements
        const logoutBtn = document.getElementById('logoutBtn');
        const profileAvatar = document.getElementById('profileAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhone = document.getElementById('userPhone');
        const completionProgress = document.getElementById('completionProgress');
        const completionPercent = document.getElementById('completionPercent');
        const displayLocation = document.getElementById('displayLocation');
        const updateLocation = document.getElementById('updateLocation');
        const locationStatus = document.getElementById('locationStatus');
        const carsContainer = document.getElementById('carsContainer');
        const ownerApprovalStatus = document.getElementById('ownerApprovalStatus');
        const ownerEarnings = document.getElementById('ownerEarnings');
        const ownerListings = document.getElementById('ownerListings');
        
        // Profile edit elements
        const avatarEdit = document.getElementById('avatarEdit');
        const profilePhotoInput = document.getElementById('profilePhotoInput');
        
        // Personal info elements
        const editPersonalInfo = document.getElementById('editPersonalInfo');
        const personalInfoForm = document.getElementById('personalInfoForm');
        const savePersonalInfo = document.getElementById('savePersonalInfo');
        const cancelPersonalInfo = document.getElementById('cancelPersonalInfo');
        const displayName = document.getElementById('displayName');
        const displayEmail = document.getElementById('displayEmail');
        const displayPhone = document.getElementById('displayPhone');
        const editName = document.getElementById('editName');
        const editPhone = document.getElementById('editPhone');
        
        // Add Car elements
        const addCarBtn = document.getElementById('addCarBtn');
        const addCarModal = document.getElementById('addCarModal');
        const closeCarModal = document.getElementById('closeCarModal');
        const cancelCarBtn = document.getElementById('cancelCarBtn');
        const saveCarBtn = document.getElementById('saveCarBtn');
        const imageUploadContainer = document.getElementById('imageUploadContainer');
        const carFuelType = document.getElementById('carFuelType');
        const carFuelEfficiency = document.getElementById('carFuelEfficiency');
        const carLocationInput = document.getElementById('carLocation');
        const carLocationLat = document.getElementById('carLocationLat');
        const carLocationLon = document.getElementById('carLocationLon');
        const locationAutocomplete = document.getElementById('locationAutocomplete');

        // Global variables
        let carImages = []; // Stores the car images to be uploaded
        let userLocation = null; // Stores the user's location coordinates

      // Notification system
function showNotification(message, isSuccess = true) {
    const notification = document.createElement('div');
    notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
    
    // Create logo image
    const logo = document.createElement('img');
    logo.src = 'images/logowhite.png';
    logo.className = 'notification-logo';
    logo.alt = 'MetroShift Logo';
    
    // Create content container
    const contentDiv = document.createElement('div');
    contentDiv.className = 'notification-content';
    
    // Create message span
    const messageSpan = document.createElement('span');
    messageSpan.className = 'notification-message';
    messageSpan.textContent = message;
    
    // Create close button
    const closeButton = document.createElement('button');
    closeButton.className = 'close-notification';
    closeButton.innerHTML = '&times;';
    
    // Assemble the notification
    contentDiv.appendChild(messageSpan);
    contentDiv.appendChild(closeButton);
    
    notification.appendChild(logo);
    notification.appendChild(contentDiv);
    
    document.body.appendChild(notification);
    
    // Trigger the animation
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    const timer = setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 400);
    }, 4000);
    
    closeButton.addEventListener('click', () => {
        clearTimeout(timer);
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 400);
    });
}
        // Update profile completion UI
        function updateProfileCompletion(percentage) {
            completionProgress.style.width = `${percentage}%`;
            completionPercent.textContent = `${percentage}%`;
        }

        // Calculate profile completion percentage
        function calculateProfileCompletion(userData, hasListings = false) {
            let completedFields = 0;
            const totalFields = 5; // name, email, phone, payment, listings
            
            if (userData.name) completedFields++;
            if (userData.email) completedFields++;
            if (userData.phone) completedFields++;
            if (userData.paymentMethod) completedFields++;
            if (hasListings) completedFields++;
            
            const percentage = Math.round((completedFields / totalFields) * 100);
            return percentage;
        }

        // Initialize image upload functionality
        function initImageUpload() {
            // Clear existing upload boxes and reset carImages
            imageUploadContainer.innerHTML = '';
            carImages = [];
            
            // Create first upload box
            createUploadBox(0);
            
            function createUploadBox(index) {
                const uploadBox = document.createElement('div');
                uploadBox.className = 'image-upload-preview';
                uploadBox.id = `imageUpload${index}`;
                uploadBox.innerHTML = `
                    <i class="fas fa-camera upload-icon"></i>
                    <input type="file" class="car-image-input" accept="image/*">
                `;
                
                const fileInput = uploadBox.querySelector('.car-image-input');
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('image/')) {
                        showNotification('Please select a valid image file.', false);
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('Image file is too large. Please select an image under 5MB.', false);
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadBox.innerHTML = `
                            <img src="${event.target.result}" alt="Car image">
                            <div class="remove-image">&times;</div>
                        `;
                        
                        // Store the image file in the global carImages array
                        carImages[index] = file;
                        
                        // Add remove event listener
                        uploadBox.querySelector('.remove-image').addEventListener('click', (e) => {
                            e.stopPropagation();
                            carImages.splice(index, 1);
                            uploadBox.remove();
                            
                            // If this was the last box and we have space, add a new empty box
                            if (carImages.length < 5 && !document.querySelector('.image-upload-preview:last-child .upload-icon')) {
                                createUploadBox(carImages.length);
                            }
                        });
                        
                        // If we have space for more images and this is the last box, add another
                        if (carImages.length < 5 && index === carImages.length - 1) {
                            createUploadBox(carImages.length);
                        }
                    };
                    reader.readAsDataURL(file);
                });
                
                // Handle click on the box to trigger file input
                uploadBox.addEventListener('click', (e) => {
                    if (e.target === uploadBox || e.target.classList.contains('upload-icon')) {
                        fileInput.click();
                    }
                });
                
                imageUploadContainer.appendChild(uploadBox);
            }
        }

        // Convert image to Base64 with compression
        async function uploadCarImage(file, index) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set canvas dimensions (resize if needed)
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 600;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw image on canvas (this will compress it)
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 with quality 0.7
                        const base64 = canvas.toDataURL('image/jpeg', 0.7);
                        resolve({
                            index,
                            base64
                        });
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Initialize location autocomplete
        function initLocationAutocomplete() {
            let timeoutId;
            
            carLocationInput.addEventListener('input', (e) => {
                clearTimeout(timeoutId);
                const query = e.target.value.trim();
                
                if (query.length < 3) {
                    locationAutocomplete.style.display = 'none';
                    return;
                }
                
                timeoutId = setTimeout(() => {
                    searchLocation(query);
                }, 300);
            });
            
            // Hide autocomplete when clicking outside
            document.addEventListener('click', (e) => {
                if (!carLocationInput.contains(e.target) && !locationAutocomplete.contains(e.target)) {
                    locationAutocomplete.style.display = 'none';
                }
            });
        }
        
        // Search location using Geoapify API
        async function searchLocation(query) {
            try {
                const response = await fetch(
                    `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&apiKey=${GEOAPIFY_API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to fetch location data');
                }
                
                const data = await response.json();
                displayAutocompleteResults(data.features);
            } catch (error) {
                console.error('Error searching location:', error);
                locationAutocomplete.innerHTML = '<div class="autocomplete-result">Error loading locations</div>';
                locationAutocomplete.style.display = 'block';
            }
        }
        
        // Display autocomplete results
        function displayAutocompleteResults(results) {
            if (!results || results.length === 0) {
                locationAutocomplete.innerHTML = '<div class="autocomplete-result">No results found</div>';
                locationAutocomplete.style.display = 'block';
                return;
            }
            
            locationAutocomplete.innerHTML = results.slice(0, 5).map(result => {
                const address = [
                    result.properties.address_line1,
                    result.properties.address_line2,
                    result.properties.city,
                    result.properties.country
                ].filter(Boolean).join(', ');
                
                return `
                    <div class="autocomplete-result" 
                         data-address="${address}" 
                         data-lat="${result.properties.lat}" 
                         data-lon="${result.properties.lon}">
                        ${address}
                    </div>
                `;
            }).join('');
            
            locationAutocomplete.style.display = 'block';
            
            // Add click handlers to results
            document.querySelectorAll('.autocomplete-result').forEach(result => {
                result.addEventListener('click', (e) => {
                    const address = result.getAttribute('data-address');
                    const lat = result.getAttribute('data-lat');
                    const lon = result.getAttribute('data-lon');
                    
                    carLocationInput.value = address;
                    carLocationLat.value = lat;
                    carLocationLon.value = lon;
                    
                    locationAutocomplete.style.display = 'none';
                });
            });
        }

        // Show owner's cars
        async function showOwnerCars(ownerId) {
            try {
                carsContainer.innerHTML = '';
                
                // Query cars where ownerId matches the current user
                const carsQuery = query(collection(db, "cars"), where("ownerId", "==", ownerId));
                const querySnapshot = await getDocs(carsQuery);
                
                if (querySnapshot.empty) {
                    carsContainer.innerHTML = `
                        <div class="no-cars">
                            <img src="videos/nocars.gif" alt="No cars available" class="no-cars-video">
                            <p>You haven't listed any cars yet.</p>
                            <button class="explore-btn" id="addFirstCarBtn">List Your First Car</button>
                        </div>
                    `;
                    
                    document.getElementById('addFirstCarBtn').addEventListener('click', () => {
                        addCarModal.style.display = 'block';
                    });
                    
                    ownerListings.textContent = '0 cars';
                    return false; // No listings
                }
                
                // Update listings count
                ownerListings.textContent = `${querySnapshot.size} ${querySnapshot.size === 1 ? 'car' : 'cars'}`;
                
                querySnapshot.forEach((doc) => {
                    const car = doc.data();
                    const carCard = document.createElement('div');
                    carCard.className = 'car-card';
                    
                    // Determine status
                    let statusClass = 'pending';
                    let statusText = 'Pending Approval';
                    
                    if (car.approved) {
                        statusClass = car.isAvailable ? 'available' : 'unavailable';
                        statusText = car.isAvailable ? 'Available' : 'Unavailable';
                    }
                    
                    // Format price
                    const formattedPrice = `R${car.pricePerDay.toFixed(2)}/day`;
                    
                    // Create specs list
                    let specsHtml = '';
                    
                    // Add fuel type and efficiency
                    if (car.fuelType) {
                        specsHtml += `
                            <div class="car-spec">
                                <i class="fas fa-gas-pump"></i> ${car.fuelType}
                            </div>
                        `;
                    }
                    
                    if (car.fuelEfficiency !== undefined) {
                        const efficiencyText = car.fuelEfficiency === 0 ? 'Electric' : `${car.fuelEfficiency}L/10km`;
                        specsHtml += `
                            <div class="car-spec">
                                <i class="fas fa-tachometer-alt"></i> ${efficiencyText}
                            </div>
                        `;
                    }
                    
                    // Format dates
                    let datesText = '';
                    if (car.availabilityDates) {
                        const startDate = new Date(car.availabilityDates.start.seconds * 1000);
                        const endDate = new Date(car.availabilityDates.end.seconds * 1000);
                        
                        datesText = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
                    }
                    
                    carCard.innerHTML = `
                        <img src="${car.images?.[0] || 'images/default-car.jpg'}" alt="${car.make} ${car.model}" class="car-image">
                        <div class="car-status ${statusClass}">${statusText}</div>
                        <div class="car-details">
                            <h3 class="car-title">${car.year} ${car.make} ${car.model}</h3>
                            <p class="car-price">${formattedPrice}</p>
                            <div class="car-specs">
                                ${specsHtml}
                            </div>
                            <div class="car-location">
                                <i class="fas fa-map-marker-alt"></i> ${car.address || 'Location not specified'}
                            </div>
                            <div class="car-location">
                                <i class="fas fa-calendar-alt"></i> ${datesText || 'Dates not specified'}
                            </div>
                        </div>
                    `;
                    
                    carsContainer.appendChild(carCard);
                });
                
                return true; // Has listings
                
            } catch (error) {
                console.error("Error loading owner's cars:", error);
                carsContainer.innerHTML = `
                    <div class="no-cars">
                        <img src="videos/nocars.gif" alt="No cars available" class="no-cars-video">
                        <p>Error loading your cars. Please try again later.</p>
                    </div>
                `;
                return false;
            }
        }

        // Helper function to reset the car form
        function resetCarForm() {
            document.getElementById('carMake').value = '';
            document.getElementById('carModel').value = '';
            document.getElementById('carYear').value = '';
            document.getElementById('carColor').value = '';
            document.getElementById('carLicensePlate').value = '';
            document.getElementById('carPrice').value = '';
            document.getElementById('carFuelType').value = '';
            document.getElementById('carFuelEfficiency').value = '';
            document.getElementById('carLocation').value = '';
            document.getElementById('carLocationLat').value = '';
            document.getElementById('carLocationLon').value = '';
            document.getElementById('availabilityStart').value = '';
            document.getElementById('availabilityEnd').value = '';
            
            // Clear images
            carImages.length = 0;
            imageUploadContainer.innerHTML = '';
            initImageUpload(); // Reinitialize upload boxes
        }

        // Save new car
        saveCarBtn.addEventListener('click', async () => {
            // Get form values
            const make = document.getElementById('carMake').value.trim();
            const model = document.getElementById('carModel').value.trim();
            const year = document.getElementById('carYear').value.trim();
            const color = document.getElementById('carColor').value.trim();
            const licensePlate = document.getElementById('carLicensePlate').value.trim();
            const price = parseFloat(document.getElementById('carPrice').value);
            const fuelType = document.getElementById('carFuelType').value;
            const fuelEfficiency = parseFloat(document.getElementById('carFuelEfficiency').value);
            const address = document.getElementById('carLocation').value.trim();
            const lat = parseFloat(document.getElementById('carLocationLat').value);
            const lon = parseFloat(document.getElementById('carLocationLon').value);
            const availabilityStart = document.getElementById('availabilityStart').value;
            const availabilityEnd = document.getElementById('availabilityEnd').value;
            
            // Validate inputs
            if (!make || !model || !year || !color || !licensePlate || isNaN(price) || 
                !fuelType || isNaN(fuelEfficiency) || fuelEfficiency < 0 ||
                !address || isNaN(lat) || isNaN(lon) || !availabilityStart || !availabilityEnd) {
                showNotification('Please fill all required fields', false);
                return;
            }
            
            if (price < 100) {
                showNotification('Price per day must be at least R100', false);
                return;
            }
            
            if (new Date(availabilityStart) > new Date(availabilityEnd)) {
                showNotification('End date must be after start date', false);
                return;
            }
            
            if (carImages.length === 0) {
                showNotification('Please upload at least one image of your car', false);
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');
                
                // Show loading state
                saveCarBtn.disabled = true;
                saveCarBtn.innerHTML = '<div class="loading"></div> Listing Car...';
                
                // Convert all images to Base64
                const imageConversionPromises = carImages.map((image, index) => {
                    if (image) {
                        return uploadCarImage(image, index);
                    }
                    return Promise.resolve(null);
                });
                
                const convertedImages = (await Promise.all(imageConversionPromises))
                    .filter(img => img !== null)
                    .sort((a, b) => a.index - b.index) // Maintain original order
                    .map(img => img.base64);
                
                // Create the car document with Base64 images
                await addDoc(collection(db, "cars"), {
                    ownerId: user.uid,
                    make: make,
                    model: model,
                    year: parseInt(year),
                    color: color,
                    licensePlate: licensePlate,
                    pricePerDay: price,
                    fuelType: fuelType,
                    fuelEfficiency: fuelEfficiency,
                    images: convertedImages,
                    address: address,
                    coordinates: {
                        latitude: lat,
                        longitude: lon
                    },
                    availabilityDates: {
                        start: new Date(availabilityStart),
                        end: new Date(availabilityEnd)
                    },
                    isAvailable: true,
                    approved: false,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                // Close modal and reset form
                addCarModal.style.display = 'none';
                resetCarForm();
                
                // Show success message
                showNotification('Car listed successfully! It will be visible after approval.');
                
                // Refresh car list and update profile completion
                const hasListings = await showOwnerCars(user.uid);
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const completionPercentage = calculateProfileCompletion(userDoc.data(), hasListings);
                    updateProfileCompletion(completionPercentage);
                }
                
            } catch (error) {
                console.error('Error listing car:', error);
                showNotification('Failed to list car. Please try again.', false);
            } finally {
                saveCarBtn.disabled = false;
                saveCarBtn.textContent = 'List My Car';
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize image upload
            initImageUpload();
            initLocationAutocomplete();
            
            // Mobile menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const navLinks = document.getElementById('navLinks');
            const overlay = document.getElementById('overlay');

            if (menuToggle && navLinks) {
                menuToggle.addEventListener('click', () => {
                    navLinks.classList.toggle('active');
                    overlay.classList.toggle('active');
                    if (navLinks.classList.contains('active')) {
                        menuToggle.innerHTML = '<i class="fas fa-times"></i>';
                    } else {
                        menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
                    }
                });

                // Close menu when clicking outside
                overlay.addEventListener('click', () => {
                    navLinks.classList.remove('active');
                    overlay.classList.remove('active');
                    menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
                });
            }

            // Add Car Modal functionality
            addCarBtn.addEventListener('click', () => {
                addCarModal.style.display = 'block';
                
                // If we have user's location, pre-fill the car location
                if (userLocation) {
                    carLocationInput.value = userLocation.address;
                    carLocationLat.value = userLocation.coordinates.latitude;
                    carLocationLon.value = userLocation.coordinates.longitude;
                }
            });

            closeCarModal.addEventListener('click', () => {
                addCarModal.style.display = 'none';
            });

            cancelCarBtn.addEventListener('click', () => {
                addCarModal.style.display = 'none';
            });

            // Close modal when clicking outside
            addCarModal.addEventListener('click', (e) => {
                if (e.target === addCarModal) {
                    addCarModal.style.display = 'none';
                }
            });

            // Personal Info Edit
            editPersonalInfo.addEventListener('click', () => {
                personalInfoForm.style.display = 'block';
            });

            cancelPersonalInfo.addEventListener('click', () => {
                personalInfoForm.style.display = 'none';
            });

            // Update location button
            updateLocation.addEventListener('click', async () => {
                try {
                    const locationData = await getDeviceLocation();
                    const user = auth.currentUser;
                    if (!user) throw new Error('User not logged in');
                    
                    // Store location for potential car location pre-fill
                    userLocation = {
                        address: locationData.address,
                        coordinates: locationData.coordinates
                    };
                    
                    const userDocRef = doc(db, "users", user.uid);
                    await updateDoc(userDocRef, {
                        location: locationData.address,
                        coordinates: locationData.coordinates,
                        updatedAt: serverTimestamp()
                    });
                    
                    // Update UI
                    displayLocation.textContent = locationData.address;
                    displayLocation.classList.remove('empty-value');
                    locationStatus.textContent = "Location updated successfully!";
                    
                    // Recalculate profile completion
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const hasListings = await showOwnerCars(user.uid);
                        const completionPercentage = calculateProfileCompletion(userDoc.data(), hasListings);
                        updateProfileCompletion(completionPercentage);
                    }
                    
                    showNotification('Location updated successfully!');
                    
                } catch (error) {
                    console.error('Error updating location:', error);
                    locationStatus.textContent = "Failed to update location. Please try again.";
                }
            });

            // Save personal info
            savePersonalInfo.addEventListener('click', async () => {
                const name = editName.value.trim();
                const phone = editPhone.value.trim();
                
                // Validate inputs
                if (name.length < 2) {
                    showNotification('Please enter a valid name (at least 2 characters)', false);
                    return;
                }
                
                if (phone && !/^\+?[\d\s\-\(\)]{8,}$/.test(phone)) {
                    showNotification('Please enter a valid phone number', false);
                    return;
                }
                
                try {
                    const user = auth.currentUser;
                    if (!user) throw new Error('User not logged in');
                    
                    const userDocRef = doc(db, "users", user.uid);
                    
                    // Show loading state
                    savePersonalInfo.disabled = true;
                    savePersonalInfo.innerHTML = '<div class="loading"></div> Saving...';
                    
                    // Update user data in Firestore
                    await updateDoc(userDocRef, {
                        name: name,
                        phone: phone || null,
                        updatedAt: serverTimestamp()
                    });
                    
                    // Update UI
                    displayName.textContent = name;
                    userName.textContent = name || user.email;
                    
                    if (phone) {
                        displayPhone.textContent = phone;
                        userPhone.textContent = phone;
                        userPhone.classList.remove('empty-value');
                    } else {
                        displayPhone.textContent = 'Not provided';
                        userPhone.textContent = 'No phone number added';
                        userPhone.classList.add('empty-value');
                    }
                    
                    // Hide form
                    personalInfoForm.style.display = 'none';
                    
                    // Update profile completion
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const hasListings = await showOwnerCars(user.uid);
                        const completionPercentage = calculateProfileCompletion(userDoc.data(), hasListings);
                        updateProfileCompletion(completionPercentage);
                    }
                    
                    showNotification('Profile updated successfully!');
                    
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showNotification('Failed to update profile. Please try again.', false);
                } finally {
                    savePersonalInfo.disabled = false;
                    savePersonalInfo.textContent = 'Save Changes';
                }
            });

            // Logout button
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Error signing out:", error);
                    showNotification('Error signing out. Please try again.', false);
                }
            });

            // Profile photo upload
            avatarEdit.addEventListener('click', () => {
                profilePhotoInput.click();
            });

            profilePhotoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select a valid image file.', false);
                    return;
                }
                
                // Validate file size (max 5MB for initial file)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Image file is too large. Please select an image under 5MB.', false);
                    return;
                }
                
                try {
                    const user = auth.currentUser;
                    if (!user) throw new Error('User not logged in');
                    
                    // Show loading state immediately
                    avatarEdit.innerHTML = '<div class="loading"></div>';
                    
                    // Create a preview URL for instant feedback
                    const previewUrl = URL.createObjectURL(file);
                    profileAvatar.src = previewUrl;
                    
                    // Compress image and convert to Base64
                    const base64Image = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // Set canvas dimensions
                                canvas.width = img.width;
                                canvas.height = img.height;
                                
                                // Draw image on canvas
                                ctx.drawImage(img, 0, 0);
                                
                                // Convert to base64 with quality 0.7
                                const base64 = canvas.toDataURL('image/jpeg', 0.7);
                                resolve(base64);
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                    
                    // Update profile picture in Firestore
                    const userDocRef = doc(db, "users", user.uid);
                    await updateDoc(userDocRef, {
                        profilePicBase64: base64Image,
                        updatedAt: serverTimestamp()
                    });
                    
                    // Update UI with compressed image
                    profileAvatar.src = base64Image;
                    avatarEdit.innerHTML = '<i class="fas fa-camera"></i>';
                    
                    showNotification('Profile picture updated successfully!');
                    
                    // Clean up preview URL
                    URL.revokeObjectURL(previewUrl);
                    
                    // Recalculate profile completion
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const hasListings = await showOwnerCars(user.uid);
                        const completionPercentage = calculateProfileCompletion(userDoc.data(), hasListings);
                        updateProfileCompletion(completionPercentage);
                    }
                    
                } catch (error) {
                    console.error('Error uploading profile picture:', error);
                    avatarEdit.innerHTML = '<i class="fas fa-camera"></i>';
                    showNotification('Failed to update profile picture. Please try again.', false);
                    
                    // Reset to default image on error
                    profileAvatar.src = "images/default-avatar.png";
                }
            });

            // Get device location using browser's Geolocation API and Geoapify for reverse geocoding
            async function getDeviceLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation is not supported by your browser'));
                        return;
                    }

                    locationStatus.textContent = "Detecting your location...";
                    updateLocation.disabled = true;
                    updateLocation.querySelector('#locationBtnText').textContent = "Detecting...";

                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            try {
                                const { latitude, longitude } = position.coords;
                                
                                // Use Geoapify Reverse Geocoding API
                                const response = await fetch(
                                    `https://api.geoapify.com/v1/geocode/reverse?lat=${latitude}&lon=${longitude}&apiKey=${GEOAPIFY_API_KEY}`,
                                    { method: 'GET' }
                                );
                                
                                if (!response.ok) {
                                    throw new Error('Failed to fetch location data');
                                }
                                
                                const data = await response.json();
                                
                                // Extract the most relevant address information
                                let locationName = "Unknown location";
                                if (data.features && data.features.length > 0) {
                                    const properties = data.features[0].properties;
                                    locationName = [
                                        properties.address_line1,
                                        properties.address_line2,
                                        properties.city,
                                        properties.country
                                    ].filter(Boolean).join(', ');
                                }
                                
                                resolve({
                                    coordinates: { latitude, longitude },
                                    address: locationName
                                });
                            } catch (error) {
                                console.error("Error getting location:", error);
                                // Fallback to just coordinates if API fails
                                resolve({
                                    coordinates: { latitude, longitude },
                                    address: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`
                                });
                            } finally {
                                updateLocation.disabled = false;
                                updateLocation.querySelector('#locationBtnText').textContent = "Update My Location";
                            }
                        },
                        (error) => {
                            console.error("Error getting position:", error);
                            locationStatus.textContent = "Location access denied. Please enable location services.";
                            updateLocation.disabled = false;
                            updateLocation.querySelector('#locationBtnText').textContent = "Update My Location";
                            reject(error);
                        },
                        { 
                            enableHighAccuracy: true,
                            timeout: 20000,
                            maximumAge: 0
                        }
                    );
                });
            }

            // Check auth state and load user data
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        // Get user data from Firestore
                        const userDocRef = doc(db, "users", user.uid);
                        const userDoc = await getDoc(userDocRef);
                        
                        let userData;
                        
                        if (userDoc.exists()) {
                            userData = userDoc.data();
                        } else {
                            // Create user document if it doesn't exist
                            userData = {
                                userId: user.uid,
                                email: user.email,
                                name: user.displayName || '',
                                phone: '',
                                profilePicBase64: '',
                                location: '',
                                coordinates: null,
                                role: 'renter', // Default to renter until approved as owner
                                ownerApproved: false,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            };
                            await setDoc(userDocRef, userData);
                            showNotification('Profile created successfully!');
                        }
                        
                        // Check if user is an approved owner
                        if (userData.role !== 'owner') {
                            // Redirect to user page if not an approved owner
                            window.location.href = "user.html";
                            return;
                        }
                        
                        // Display user info
                        userName.textContent = userData.name || user.email;
                        userEmail.textContent = user.email;
                        displayName.textContent = userData.name || 'Not provided';
                        displayEmail.textContent = user.email;
                        
                        if (userData.phone) {
                            userPhone.textContent = userData.phone;
                            displayPhone.textContent = userData.phone;
                            userPhone.classList.remove('empty-value');
                        } else {
                            userPhone.textContent = 'No phone number added';
                            displayPhone.textContent = 'Not provided';
                            userPhone.classList.add('empty-value');
                        }
                        
                        if (userData.location) {
                            displayLocation.textContent = userData.location;
                            displayLocation.classList.remove('empty-value');
                            
                            // Store user location for potential car location pre-fill
                            if (userData.coordinates) {
                                userLocation = {
                                    address: userData.location,
                                    coordinates: {
                                        latitude: userData.coordinates.latitude,
                                        longitude: userData.coordinates.longitude
                                    }
                                };
                            }
                        } else {
                            displayLocation.textContent = 'Location not set';
                            displayLocation.classList.add('empty-value');
                            // Try to fetch location automatically on first load if not set
                            try {
                                const locationData = await getDeviceLocation();
                                await updateDoc(userDocRef, {
                                    location: locationData.address,
                                    coordinates: locationData.coordinates,
                                    updatedAt: serverTimestamp()
                                });
                                displayLocation.textContent = locationData.address;
                                displayLocation.classList.remove('empty-value');
                                
                                // Store for car location pre-fill
                                userLocation = {
                                    address: locationData.address,
                                    coordinates: locationData.coordinates
                                };
                            } catch (error) {
                                console.error('Error fetching initial location:', error);
                            }
                        }
                        
                        // Update profile picture - use Base64 from Firestore
                        if (userData.profilePicBase64) {
                            profileAvatar.src = userData.profilePicBase64;
                        } else {
                            // Default avatar if no profile picture
                            profileAvatar.src = "images/default-avatar.png";
                        }
                        
                        // Update owner status
                        ownerApprovalStatus.textContent = userData.ownerApproved ? 'Approved' : 'Pending Approval';
                        ownerApprovalStatus.style.color = userData.ownerApproved ? 'var(--primary-green)' : 'var(--accent-yellow)';
                        
                        // Load owner's cars and calculate profile completion
                        const hasListings = await showOwnerCars(user.uid);
                        const completionPercentage = calculateProfileCompletion(userData, hasListings);
                        updateProfileCompletion(completionPercentage);
                        
                    } catch (error) {
                        console.error("Error getting user data:", error);
                        showNotification('Error loading profile data. Please try again.', false);
                    }
                } else {
                    // User is not logged in, redirect to home page
                    window.location.href = "index.html";
                }
            });
        });
    </script>
</body>
</html>